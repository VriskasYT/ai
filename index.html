<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&family=Google+Sans+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script async src="https://telegram.org/js/telegram-widget.js?22"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f4;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #80868b;
            --border-color: #e8eaed;
            --accent: #1a73e8;
            --accent-hover: #1557b0;
            --accent-light: #e8f0fe;
            --success: #34a853;
            --warning: #fbbc04;
            --error: #ea4335;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --header-height: 56px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        .dark-theme {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-tertiary: #80868b;
            --border-color: #3c4043;
            --accent: #8ab4f8;
            --accent-hover: #aecbfa;
            --accent-light: #1a3a5c;
        }
        
        html, body { height: 100%; height: 100dvh; overflow: hidden; margin: 0; padding: 0; }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            transition: background 0.3s, color 0.3s;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
            height: var(--header-height);
            min-height: var(--header-height);
            flex-shrink: 0;
            gap: 8px;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .header-center { flex: 1; display: flex; justify-content: center; min-width: 0; }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .icon-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .icon-btn:active { transform: scale(0.97); }
        .icon-btn svg { width: 20px; height: 20px; transition: transform 0.15s ease; }
        .icon-btn:hover svg { transform: scale(1.03); }

        .model-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-xl);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            max-width: 200px;
            font-family: inherit;
        }

        .model-btn:hover { background: var(--border-color); transform: translateY(-1px); }
        .model-btn:active { transform: translateY(0); }
        .model-btn-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .model-btn svg { width: 18px; height: 18px; flex-shrink: 0; transition: transform 0.2s; }
        .model-btn.open svg { transform: rotate(180deg); }

        .model-dropdown {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            width: 90vw;
            max-width: 420px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            z-index: 800;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        .model-dropdown.show { 
            display: block; 
            animation: dropdownFade 0.2s ease-out; 
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-search {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            z-index: 1;
        }

        .model-search input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .model-search input:focus { border-color: var(--accent); }

        .model-category {
            padding: 10px 14px 6px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
            position: sticky;
            top: 57px;
        }

        .model-option {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.15s;
            gap: 10px;
        }

        .model-option:hover, .model-option:active { background: var(--bg-tertiary); padding-left: 16px; }
        .model-option { transition: all 0.1s ease; }
        .model-option.selected { background: var(--accent-light); }
        .model-option.hidden { display: none; }

        .model-option-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .model-info { flex: 1; min-width: 0; }
        .model-name { font-size: 14px; font-weight: 500; color: var(--text-primary); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .model-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .model-badges { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }

        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--bg-tertiary); white-space: nowrap; }
        .badge.new { background: #fce8e6; color: #c5221f; }
        .badge.vision { background: #e8f0fe; color: #1967d2; }
        .badge.search { background: #fef7e0; color: #ea8600; }
        .badge.reasoning { background: #e6f4ea; color: #137333; }
        .badge.code { background: #fff3e0; color: #e65100; }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }

        .overlay.show { 
            display: block;
            opacity: 1; 
            visibility: visible; 
            pointer-events: auto;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 360px;
            height: 100%;
            background: var(--bg-primary);
            z-index: 600;
            transition: right 0.3s ease, left 0.3s ease;
            display: flex;
            flex-direction: column;
            overscroll-behavior: contain;
        }

        .side-panel.open { right: 0; box-shadow: var(--shadow-lg); }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            min-height: 56px;
            flex-shrink: 0;
        }

        .panel-title { font-size: 18px; font-weight: 500; }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .settings-section { margin-bottom: 24px; }

        .settings-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .setting-item:last-child { border-bottom: none; }
        .setting-item { transition: background 0.1s ease; }
        .setting-item:hover { background: var(--bg-secondary); border-radius: var(--radius-sm); }
        .setting-info { flex: 1; min-width: 0; }
        .setting-name { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .setting-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        .setting-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .setting-status.active { background: var(--accent-light); color: var(--accent); }
        .setting-status.unavailable { background: #fce8e6; color: #c5221f; }

        .toggle { position: relative; width: 48px; height: 28px; flex-shrink: 0; }
        .toggle input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--border-color);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle input:checked + .toggle-slider { background: var(--accent); }
        .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
        .toggle input:disabled + .toggle-slider { opacity: 0.4; cursor: not-allowed; }

        .slider-container { margin-top: 8px; padding: 12px 0; }
        .slider-header { display: flex; justify-content: space-between; font-size: 14px; color: var(--text-primary); margin-bottom: 10px; }
        .slider-value { font-weight: 500; color: var(--accent); }

        input[type="range"] { width: 100%; height: 4px; border-radius: 2px; background: var(--border-color); outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }

        .system-prompt-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .system-prompt-input:focus { border-color: var(--accent); }

        .chat-container { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 20px 20px;
            text-align: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .welcome-screen {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .welcome-screen.hiding {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .welcome-screen.hidden { 
            display: none;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .messages-wrapper {
            animation: fadeIn 0.3s ease-out;
        }

        .messages-wrapper.showing {
            animation: slideIn 0.3s ease-out;
        }

        /* Smooth icon transitions */
        .icon-btn svg {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .icon-btn:active svg {
            transform: scale(0.9);
        }

        /* Settings button rotation animation */
        .icon-btn.settings-rotating svg {
            animation: settingsRotate 0.5s ease-out;
        }

        @keyframes settingsRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(180deg); }
        }

        .welcome-logo { width: 80px; height: 80px; margin-bottom: 24px; animation: welcomePulse 3s ease-in-out infinite; flex-shrink: 0; }

        @keyframes welcomePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .welcome-title {
            font-size: clamp(28px, 8vw, 44px);
            font-weight: 400;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #4285f4, #ea4335, #fbbc04, #34a853);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 1.2em;
        }

        .welcome-subtitle { font-size: 16px; color: var(--text-secondary); margin-bottom: 32px; }

        .suggestions { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; max-width: 600px; width: 100%; }

        .suggestion {
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text-primary);
        }

        .suggestion:hover, .suggestion:active { background: var(--bg-primary); border-color: var(--accent); box-shadow: var(--shadow-sm); transform: translateY(-2px); }
        .suggestion { transition: all 0.15s ease; }
        .suggestion-icon { font-size: 20px; margin-bottom: 6px; }
        .suggestion-text { color: var(--text-secondary); font-size: 13px; }

        .messages-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        .messages-wrapper.hidden { display: none; }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            background: var(--bg-primary);
            min-height: 0;
        }

        .message {
            display: flex;
            gap: 12px;
            padding: 16px 0;
            max-width: 800px;
            margin: 0 auto;
            animation: messageFade 0.3s ease-out;
        }

        @keyframes messageFade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            overflow: hidden;
        }

        .message.user .message-avatar { background: var(--accent); color: white; }

        .message-body { flex: 1; min-width: 0; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .message-author { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .message-time { font-size: 12px; color: var(--text-tertiary); }
        .message-gen-time { font-size: 11px; color: var(--text-tertiary); background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; }

        .message-content { font-size: 15px; line-height: 1.7; color: var(--text-primary); word-wrap: break-word; overflow-wrap: break-word; }
        .message-content p { margin-bottom: 12px; }
        .message-content p:last-child { margin-bottom: 0; }

        .message-content h1 { font-size: 1.8em; font-weight: 600; margin: 20px 0 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); }
        .message-content h2 { font-size: 1.5em; font-weight: 600; margin: 18px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border-color); }
        .message-content h3 { font-size: 1.25em; font-weight: 600; margin: 16px 0 8px; }
        .message-content h4 { font-size: 1.1em; font-weight: 600; margin: 14px 0 6px; }

        .message-content code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-family: 'Google Sans Mono', monospace; font-size: 0.9em; color: #d63384; }
        .dark-theme .message-content code { color: #f0a8c4; }

        .message-content pre { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: var(--radius-sm); overflow-x: auto; margin: 12px 0; position: relative; }
        .message-content pre code { background: none; padding: 0; color: inherit; font-size: 13px; }

        .code-header { display: flex; justify-content: space-between; align-items: center; background: #2d2d2d; padding: 8px 12px; border-radius: var(--radius-sm) var(--radius-sm) 0 0; margin: 12px 0 0; }
        .code-lang { font-size: 12px; color: #888; text-transform: uppercase; font-weight: 500; }
        .code-actions { display: flex; gap: 8px; }
        .code-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; font-family: inherit; }
        .code-btn:hover { background: #3d3d3d; color: #fff; }
        .message-content pre.with-header { margin-top: 0; border-radius: 0 0 var(--radius-sm) var(--radius-sm); }

        .message-content ul, .message-content ol { margin: 12px 0; padding-left: 24px; }
        .message-content ul { list-style-type: disc; }
        .message-content ol { list-style-type: decimal; }
        .message-content li { margin-bottom: 6px; line-height: 1.6; }
        .message-content a { color: var(--accent); text-decoration: none; }
        .message-content a:hover { text-decoration: underline; }

        .message-content blockquote {
            border-left: 4px solid var(--accent);
            padding: 12px 16px;
            margin: 16px 0;
            background: var(--bg-secondary);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-content table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
        .message-content th, .message-content td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; }
        .message-content th { background: var(--bg-secondary); font-weight: 600; }

        /* File Operation Blocks - LMArena Style */
        .file-op-block {
            background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%);
            border: 1px solid #42a5f5;
            border-radius: var(--radius-md);
            margin: 16px 0;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .dark-theme .file-op-block { background: linear-gradient(135deg, #1a3a5c 0%, #1a3a2a 100%); }

        .file-op-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #1565c0;
            cursor: pointer;
            user-select: none;
            background: rgba(66, 165, 245, 0.1);
        }

        .dark-theme .file-op-header { color: #64b5f6; }

        .file-op-header svg { width: 18px; height: 18px; transition: transform 0.2s; flex-shrink: 0; }
        .file-op-header.collapsed svg { transform: rotate(-90deg); }
        .file-op-icon { font-size: 18px; }
        .file-op-path { font-family: 'Google Sans Mono', monospace; font-weight: 600; }

        .file-op-type {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(21, 101, 192, 0.2);
            margin-left: auto;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .file-op-content { border-top: 1px solid rgba(66, 165, 245, 0.3); display: none; }
        .dark-theme .file-op-content { background: rgba(0,0,0,0.2); }
        .file-op-content.visible { display: block; }
        .file-op-content.hidden { display: none; }

        .file-op-code {
            padding: 16px;
            font-family: 'Google Sans Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
            color: #d4d4d4;
            background: #1e1e1e;
            line-height: 1.5;
            border-radius: 0;
        }

        .file-op-status {
            padding: 10px 16px;
            font-size: 13px;
            color: var(--success);
            background: rgba(52, 168, 83, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .file-op-pending {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ff9800;
        }
        .dark-theme .file-op-pending { background: linear-gradient(135deg, #4a3000 0%, #5a3800 100%); }

        .file-op-pending .file-op-header { color: #e65100; }
        .dark-theme .file-op-pending .file-op-header { color: #ffb74d; }

        .file-op-pending .file-op-status {
            color: #e65100;
            background: rgba(230, 81, 0, 0.1);
        }

        .file-op-indicator {
            font-family: 'Google Sans Mono', monospace;
            font-weight: 600;
            color: #e65100;
        }

        @keyframes opPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .file-op-pending .file-op-indicator {
            animation: opPulse 1s ease-in-out infinite;
        }

        .file-op-progress {
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .file-op-progress-bar {
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, #ff9800, #ff5722, #ff9800);
            background-size: 200% 100%;
            border-radius: 2px;
            animation: progressAnim 1.5s ease-in-out infinite;
        }

        @keyframes progressAnim {
            0% { width: 20%; margin-left: 0; background-position: 0% 0%; }
            50% { width: 50%; margin-left: 25%; background-position: 100% 0%; }
            100% { width: 20%; margin-left: 80%; background-position: 0% 0%; }
        }

        .file-op-stopped {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ff9800;
        }
        .dark-theme .file-op-stopped { background: linear-gradient(135deg, #4a3000 0%, #5a3800 100%); }
        .file-op-stopped .file-op-header { color: #e65100; }
        .file-op-stopped .file-op-status { color: #e65100; background: rgba(230, 81, 0, 0.1); }

        .file-op-failed {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #f44336;
        }
        .dark-theme .file-op-failed { background: linear-gradient(135deg, #4a0000 0%, #5a1010 100%); }
        .file-op-failed .file-op-header { color: #c62828; }
        .file-op-failed .file-op-status { color: #c62828; background: rgba(198, 40, 40, 0.1); }

        /* Thinking Block */
        .thinking-block {
            background: linear-gradient(135deg, #e6f4ea 0%, #e8f0fe 100%);
            border: 1px solid #34a853;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .dark-theme .thinking-block { background: linear-gradient(135deg, #1a3a2a 0%, #1a3a5c 100%); }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #137333;
            cursor: pointer;
            user-select: none;
            background: rgba(52, 168, 83, 0.1);
        }

        .dark-theme .thinking-header { color: #81c995; }
        .thinking-header svg { width: 18px; height: 18px; transition: transform 0.2s; }
        .thinking-header.collapsed svg { transform: rotate(-90deg); }

        .thinking-content {
            padding: 16px;
            border-top: 1px solid rgba(52, 168, 83, 0.3);
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
            background: rgba(0,0,0,0.02);
            display: none;
        }

        .thinking-content.visible { display: block; }
        .thinking-content.hidden { display: none; }

        /* Search Block */
        .search-block {
            background: linear-gradient(135deg, #fef7e0 0%, #fff3e0 100%);
            border: 1px solid #ea8600;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .dark-theme .search-block { background: linear-gradient(135deg, #3d3000 0%, #4a2c00 100%); }

        .search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #ea8600;
            cursor: pointer;
            user-select: none;
            background: rgba(234, 134, 0, 0.1);
        }

        .search-header svg { width: 18px; height: 18px; transition: transform 0.2s; flex-shrink: 0; }
        .search-header.collapsed svg { transform: rotate(-90deg); }

        .search-sources {
            padding: 12px 16px;
            border-top: 1px solid rgba(234, 134, 0, 0.3);
            background: rgba(0,0,0,0.02);
        }

        .search-sources.hidden { display: none; }

        .search-sources-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .search-sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .search-source {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .search-source:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .search-source-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
        }

        .search-source-favicon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .search-source-info {
            flex: 1;
            min-width: 0;
        }

        .search-source-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .search-source-url {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-source-number {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-attachments { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .message-attachment-img { max-width: 200px; max-height: 150px; border-radius: var(--radius-sm); cursor: pointer; transition: transform 0.2s; }
        .message-attachment-img:hover { transform: scale(1.02); }
        .message-attachment-file { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 13px; }

        .message-actions { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .action-btn:hover, .action-btn:active { background: var(--border-color); color: var(--text-primary); transform: translateY(-1px); }
        .action-btn { transition: all 0.1s ease; }

        .generated-image { max-width: 100%; max-height: 400px; border-radius: var(--radius-md); margin: 12px 0; box-shadow: var(--shadow-md); cursor: pointer; }

        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        .input-area {
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-area-bottom));
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
            z-index: 50;
        }

        .input-container { max-width: 800px; margin: 0 auto; }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 8px 8px 8px 16px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }

        .input-wrapper textarea {
            flex: 1;
            border: none;
            background: none;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.5;
            padding: 6px 0;
            color: var(--text-primary);
        }

        .input-wrapper textarea::placeholder { color: var(--text-tertiary); }
        .input-actions { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }

        .attach-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .attach-btn:hover, .attach-btn:active { background: var(--bg-tertiary); color: var(--text-primary); }
        .attach-btn svg { width: 20px; height: 20px; }
        .attach-btn.hidden { display: none; }
        .attach-btn.recording { background: var(--error); color: white; animation: recordPulse 1s infinite; }
        @keyframes recordPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) { background: var(--accent-hover); transform: scale(1.03); }
        .send-btn:disabled { background: var(--bg-tertiary); color: var(--text-tertiary); cursor: not-allowed; }
        .send-btn svg { width: 20px; height: 20px; }
        .stop-btn { background: var(--error); }
        .stop-btn:hover:not(:disabled) { background: #c5221f; }

        .attached-files { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .attached-files:empty { display: none; }

        .attached-file { position: relative; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .attached-file.image { width: 80px; height: 80px; }
        .attached-file.image img { width: 100%; height: 100%; object-fit: cover; }
        .attached-file.document { display: flex; align-items: center; gap: 8px; padding: 10px 14px; font-size: 13px; max-width: 200px; }

        .attached-file .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }

        .input-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 12px; color: var(--text-tertiary); gap: 8px; }
        .char-count { font-variant-numeric: tabular-nums; flex-shrink: 0; }
        @media (min-width: 769px) { .shortcuts-hint { display: block !important; } }

        .active-features { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; min-width: 0; }

        .feature-pill { font-size: 11px; padding: 3px 8px; border-radius: 12px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .feature-pill.streaming { background: #e8f0fe; color: #1967d2; }
        .feature-pill.reasoning { background: #e6f4ea; color: #137333; }
        .feature-pill.search { background: #fef7e0; color: #ea8600; }
        .feature-pill.code { background: #fff3e0; color: #e65100; }
        .feature-pill.vision { background: #f3e8fd; color: #7c3aed; }

        .dark-theme .feature-pill.streaming { background: #1a3a5c; }
        .dark-theme .feature-pill.reasoning { background: #1a3a2a; }
        .dark-theme .feature-pill.search { background: #3d3000; }
        .dark-theme .feature-pill.code { background: #4a2c00; }
        .dark-theme .feature-pill.vision { background: #2d1a4a; }

        .image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .image-modal.show { display: flex; }
        .image-modal img { max-width: 100%; max-height: 100%; border-radius: var(--radius-sm); }
        .image-modal .close-modal { position: absolute; top: 20px; right: 20px; width: 44px; height: 44px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: var(--radius-xl);
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            max-width: 90vw;
            text-align: center;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; animation: toastPop 0.2s ease; }
        @keyframes toastPop { from { transform: translateX(-50%) translateY(10px) scale(0.95); } to { transform: translateX(-50%) translateY(0) scale(1); } }

        /* Particles removed */

        /* Typing cursor animation */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--accent);
            margin-left: 2px;
            animation: cursorBlink 1s infinite;
        }

        /* Gradient text animation for loading */
        .gradient-loading {
            background: linear-gradient(90deg, var(--accent), #ea4335, #fbbc04, #34a853, var(--accent));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientMove 2s linear infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* Shine effect on completed file ops */
        .file-op-block:not(.file-op-pending):not(.file-op-stopped):not(.file-op-failed) .file-op-header {
            background: linear-gradient(90deg, rgba(66, 165, 245, 0.1) 0%, rgba(52, 168, 83, 0.15) 50%, rgba(66, 165, 245, 0.1) 100%);
        }

        /* Smooth scroll behavior */
        .messages {
            scroll-behavior: smooth;
        }

        /* Better focus states */
        button:focus-visible, input:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Smooth message appearance */
        .message {
            animation: messageFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Model badge shine effect */
        .badge.new {
            animation: badgeShine 2s ease-in-out infinite;
        }

        @keyframes badgeShine {
            0%, 100% { box-shadow: 0 0 0 rgba(197, 34, 31, 0); }
            50% { box-shadow: 0 0 8px rgba(197, 34, 31, 0.5); }
        }

        .scroll-bottom-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            z-index: 50;
        }

        .scroll-bottom-btn.show { display: flex; }
        .scroll-bottom-btn svg { width: 20px; height: 20px; }

        /* Очень слабые анимации */
        .icon-btn, .action-btn, .send-btn, .attach-btn, .model-btn, .suggestion, .setting-item, .file-tree-item {
            transition: all 0.12s ease;
        }
        
        .icon-btn:hover { transform: scale(1.02); }
        .action-btn:hover { transform: translateY(-1px); }
        .suggestion:hover { transform: translateY(-1px); }
        .file-tree-item:hover { transform: translateX(2px); }
        .model-option:hover { transform: translateX(2px); }
        
        @keyframes subtleFadeIn {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }
        
        .message {
            animation: subtleFadeIn 0.2s ease;
        }

        /* File Explorer Panel */
        .file-explorer {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100%;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            z-index: 700;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .file-explorer.open { 
            left: 0; 
            pointer-events: auto;
        }

        .file-explorer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            min-height: 56px;
        }

        .file-explorer-title {
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-explorer-actions {
            display: flex;
            gap: 4px;
        }

        .file-explorer-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
        }

        .file-tree-item:hover { background: var(--bg-tertiary); transform: translateX(2px); }
        .file-tree-item { transition: all 0.1s ease; }
        .file-tree-item.selected { background: var(--accent-light); }

        .file-tree-icon { font-size: 16px; flex-shrink: 0; }
        .file-tree-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-tree-size { font-size: 11px; color: var(--text-tertiary); }

        .file-tree-folder { padding-left: 8px; }
        .file-tree-folder.collapsed > .file-tree-children { display: none; }
        .file-tree-children { padding-left: 16px; }

        .file-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .file-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .file-preview-modal.show { display: flex; }

        .file-preview-content {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }

        .file-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .file-preview-title {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-preview-body {
            flex: 1;
            overflow: auto;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Google Sans Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 70vh;
        }

        .file-preview-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .header { padding: 8px 12px; height: 52px; min-height: 52px; }
            .logo span { display: none; }
            .model-btn { max-width: 140px; padding: 8px 12px; }
            .chat-container { flex: 1; min-height: 0; display: flex; flex-direction: column; }
            .messages-wrapper { flex: 1; min-height: 0; display: flex; flex-direction: column; }
            .messages { flex: 1; padding: 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .message { gap: 10px; }
            .message-avatar { width: 32px; height: 32px; }
            .input-area { padding: 10px 12px; padding-bottom: calc(10px + var(--safe-area-bottom)); flex-shrink: 0; }
            .suggestions { grid-template-columns: 1fr; gap: 10px; }
            .side-panel { max-width: 100%; }
            .scroll-bottom-btn { bottom: 100px; right: 12px; }
            .file-explorer { width: 100%; left: -100%; }
            .file-preview-content { min-width: 90vw; }
            .welcome-screen { 
                padding: 20px 16px; 
                display: flex; 
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                overflow-y: auto;
                flex: 1;
                min-height: 0;
            }
            .welcome-logo { width: 60px; height: 60px; margin-bottom: 16px; }
            .welcome-title { 
                font-size: 28px; 
                margin-bottom: 8px;
            }
            .welcome-subtitle { font-size: 14px; margin-bottom: 20px; }
            .suggestion { padding: 12px 14px; }
            .suggestion-icon { font-size: 18px; }
        }

        @media (max-width: 480px) {
            .header { padding: 6px 10px; gap: 4px; height: 48px; min-height: 48px; }
            .icon-btn { width: 34px; height: 34px; }
            .model-btn { max-width: 120px; padding: 6px 10px; font-size: 13px; }
            .chat-container { flex: 1; min-height: 0; display: flex; flex-direction: column; }
            .messages-wrapper { flex: 1; min-height: 0; display: flex; flex-direction: column; }
            .messages { flex: 1; padding: 8px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .message { padding: 8px 0; gap: 8px; }
            .message-avatar { width: 28px; height: 28px; font-size: 11px; }
            .message-content { font-size: 14px; }
            .input-area { padding: 6px 8px; padding-bottom: calc(6px + var(--safe-area-bottom)); flex-shrink: 0; }
            .input-wrapper { padding: 4px 4px 4px 10px; }
            .input-wrapper textarea { font-size: 15px; }
            .send-btn { width: 34px; height: 34px; }
            .attach-btn { width: 30px; height: 30px; }
            .input-footer { font-size: 10px; margin-top: 4px; }
            .welcome-screen { 
                padding: 12px; 
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                overflow-y: auto;
                flex: 1;
                min-height: 0;
            }
            .welcome-logo { width: 48px; height: 48px; margin-bottom: 12px; }
            .welcome-title { 
                font-size: 24px; 
                margin-bottom: 4px;
            }
            .welcome-subtitle { font-size: 13px; margin-bottom: 16px; }
            .panel-content { padding: 12px; }
            .setting-item { padding: 10px 0; }
            .suggestions { gap: 6px; grid-template-columns: 1fr; }
            .suggestion { padding: 10px 12px; }
            .suggestion-icon { font-size: 16px; margin-bottom: 4px; }
            .suggestion-text { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- File Explorer -->
    <div class="file-explorer" id="fileExplorer">
        <div class="file-explorer-header">
            <span class="file-explorer-title">📁 Проводник</span>
            <div class="file-explorer-actions">
                <button class="icon-btn" onclick="createNewFile()" title="Новый файл">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9H13z"/></svg>
                </button>
                <button class="icon-btn" onclick="createNewFolder()" title="Новая папка">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                </button>
                <button class="icon-btn" onclick="toggleFileExplorer()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>
        <div class="file-explorer-content" id="fileExplorerContent">
            <div class="file-empty">
                <p>📂 Файлы появятся здесь</p>
                <p style="font-size:12px;margin-top:8px;">Попросите AI создать файл</p>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="file-preview-modal" id="filePreviewModal" onclick="closeFilePreview(event)">
        <div class="file-preview-content" onclick="event.stopPropagation()">
            <div class="file-preview-header">
                <span class="file-preview-title" id="filePreviewTitle">📄 file.txt</span>
                <button class="icon-btn" onclick="closeFilePreview()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="file-preview-body" id="filePreviewBody"></div>
            <div class="file-preview-actions">
                <button class="action-btn" onclick="copyFileContent()">📋 Копировать</button>
                <button class="action-btn" onclick="downloadCurrentFile()">💾 Скачать</button>
                <button class="action-btn" onclick="openInNewTab()" id="openInTabBtn" style="display:none;">🚀 Открыть</button>
                <button class="action-btn" onclick="deleteCurrentFile()" style="background:#fce8e6;color:#c5221f;">🗑️ Удалить</button>
            </div>
        </div>
    </div>

    <div class="side-panel" id="settingsPanel">
        <div class="panel-header">
            <span class="panel-title">⚙️ Настройки</span>
            <button class="icon-btn" onclick="toggleSettings()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="panel-content">
            <div class="settings-section">
                <div class="settings-section-title">🎨 Интерфейс</div>
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">Тёмная тема</div></div>
                    <label class="toggle"><input type="checkbox" id="darkThemeToggle" onchange="toggleDarkTheme()"><span class="toggle-slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">Автопрокрутка</div></div>
                    <label class="toggle"><input type="checkbox" id="autoScrollToggle"><span class="toggle-slider"></span></label>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">⚡ Генерация</div>
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">Потоковый вывод</div></div>
                    <label class="toggle"><input type="checkbox" id="streamingToggle" checked onchange="updateActiveFeatures()"><span class="toggle-slider"></span></label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">🧠 Reasoning (думать)</div></div>
                    <span class="setting-status" id="reasoningStatus">Недоступно</span>
                    <label class="toggle"><input type="checkbox" id="reasoningToggle" onchange="updateActiveFeatures()"><span class="toggle-slider"></span></label>
                </div>

                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">🔍 Поиск в интернете</div></div>
                    <span class="setting-status" id="searchStatus">Недоступно</span>
                    <label class="toggle"><input type="checkbox" id="searchToggle" onchange="updateActiveFeatures()"><span class="toggle-slider"></span></label>
                </div>

                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">💻 Режим кода (файлы)</div></div>
                    <span class="setting-status" id="codeStatus">Недоступно</span>
                    <label class="toggle"><input type="checkbox" id="codeExecToggle" onchange="updateActiveFeatures()"><span class="toggle-slider"></span></label>
                </div>

                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">👁️ Vision (анализ фото)</div></div>
                    <span class="setting-status" id="visionStatus">Недоступно</span>
                    <label class="toggle"><input type="checkbox" id="visionToggle" onchange="updateActiveFeatures();updateAttachButtons()"><span class="toggle-slider"></span></label>
                </div>

                <div class="slider-container">
                    <div class="slider-header"><span>Температура</span><span class="slider-value" id="tempValue">0.7</span></div>
                    <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7" oninput="updateTempValue()">
                </div>
                <div class="slider-container">
                    <div class="slider-header"><span>Макс. токенов</span><span class="slider-value" id="tokensValue">4096</span></div>
                    <input type="range" id="tokensSlider" min="256" max="16384" step="256" value="4096" oninput="updateTokensValue()">
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">📝 Системный промпт</div>
                <textarea class="system-prompt-input" id="systemPrompt" placeholder="Опишите поведение ассистента..."></textarea>
            </div>

            <div class="settings-section" id="authSection">
                <div class="settings-section-title">👤 Аккаунт</div>
                <div id="authNotLoggedIn">
                    <div style="background:var(--accent-light);padding:16px;border-radius:var(--radius-md);margin-bottom:12px;">
                        <p style="font-size:14px;color:var(--text-primary);margin-bottom:8px;">🔐 <strong>Войдите в аккаунт</strong></p>
                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Зарегистрируйтесь или войдите чтобы сохранить ваши чаты в облаке. Все ваши локальные чаты будут скопированы на аккаунт.</p>
                        <div id="telegramLoginWidget"></div>
                    </div>
                </div>
                <div id="authLoggedIn" style="display:none;">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name" id="authUserName">Пользователь</div>
                            <div class="setting-desc" id="authUserInfo">Синхронизация включена ☁️</div>
                        </div>
                        <button class="action-btn" onclick="logoutUser()" style="background:#fce8e6;color:#c5221f;">Выйти</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">💾 Данные</div>
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">Экспорт чата</div></div>
                    <button class="action-btn" onclick="exportChat()">📥 Скачать</button>
                </div>
                <div class="setting-item">
                    <div class="setting-info"><div class="setting-name">Очистить историю</div></div>
                    <button class="action-btn" onclick="clearAllChats()" style="background:#fce8e6;color:#c5221f;">🗑️ Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="side-panel" id="historyPanel" style="left:-100%;right:auto;">
        <div class="panel-header">
            <span class="panel-title">📚 История</span>
            <button class="icon-btn" onclick="toggleHistory()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="panel-content" id="historyList">
            <p style="color:var(--text-secondary);text-align:center;padding:20px;">История пуста</p>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <button class="icon-btn" onclick="toggleHistory()" title="История">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <button class="icon-btn" onclick="toggleFileExplorer()" title="Проводник">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
            </button>
            <a class="logo" onclick="newChat()">
                <div class="logo-icon" id="headerLogo"></div>
                <span>AI Studio</span>
                <span id="syncStatus" style="font-size:12px;margin-left:4px;" title="Статус синхронизации"></span>
            </a>
        </div>

        <div class="header-center">
            <div class="model-selector">
                <button class="model-btn" id="modelBtn" onclick="toggleModelDropdown()">
                    <span class="model-btn-text" id="selectedModelName">Gemini 3 Flash</span>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
            </div>
        </div>

        <div class="header-right">
            <button class="icon-btn" id="newChatBtn" onclick="newChat()" style="display:none;">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            <button class="icon-btn" onclick="toggleSettings()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>
    </header>

    <div class="model-dropdown" id="modelDropdown">
        <div class="model-search">
            <input type="text" id="modelSearchInput" placeholder="Поиск модели..." oninput="filterModels()">
        </div>
        <div id="modelList"></div>
    </div>

    <div class="chat-container">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-logo" id="welcomeLogo"></div>
            <h1 class="welcome-title">Привет!</h1>
            <p class="welcome-subtitle">Чем могу помочь сегодня?</p>
            
            <div class="suggestions">
                <div class="suggestion" onclick="useSuggestion('Создай игру змейку на HTML/CSS/JavaScript')">
                    <div class="suggestion-icon">🐍</div>
                    <div class="suggestion-text">Создай игру змейку</div>
                </div>
                <div class="suggestion" onclick="useSuggestion('Создай красивое TODO приложение с анимациями')">
                    <div class="suggestion-icon">✅</div>
                    <div class="suggestion-text">TODO приложение</div>
                </div>
                <div class="suggestion" onclick="useSuggestion('Сгенерируй изображение: футуристический город на закате')">
                    <div class="suggestion-icon">🎨</div>
                    <div class="suggestion-text">Нарисуй город будущего</div>
                </div>
                <div class="suggestion" onclick="useSuggestion('Создай калькулятор с красивым дизайном')">
                    <div class="suggestion-icon">🧮</div>
                    <div class="suggestion-text">Создай калькулятор</div>
                </div>
                <div class="suggestion" onclick="useSuggestion('Напиши интересную короткую историю про космос')">
                    <div class="suggestion-icon">🚀</div>
                    <div class="suggestion-text">Расскажи историю про космос</div>
                </div>
                <div class="suggestion" onclick="useSuggestion('Создай веб-страницу портфолио с современным дизайном')">
                    <div class="suggestion-icon">💼</div>
                    <div class="suggestion-text">Сделай портфолио сайт</div>
                </div>
            </div>
        </div>

        <div class="messages-wrapper hidden" id="messagesWrapper">
            <div class="messages" id="messages"></div>
        </div>

        <button class="scroll-bottom-btn" id="scrollBottomBtn" onclick="scrollToBottom()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </button>

        <div class="input-area">
            <div class="input-container">
                <div class="attached-files" id="attachedFiles"></div>
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="Напишите сообщение..." rows="1" onkeydown="handleKeydown(event)" oninput="autoResize(this);updateCharCount()"></textarea>
                    <div class="input-actions">
                        <!-- Voice button removed -->
                        <button class="attach-btn" id="imageAttachBtn" onclick="document.getElementById('imageInput').click()" title="Прикрепить изображение">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        </button>
                        <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Прикрепить файл">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display:none" onchange="handleImageUpload(event)">
                        <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileUpload(event)">
                        <button class="send-btn" id="sendBtn" onclick="handleSendClick()" disabled>
                            <svg id="sendIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            <svg id="stopIcon" style="display:none" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="input-footer">
                    <div class="active-features" id="activeFeatures"></div>
                    <div class="shortcuts-hint" style="font-size:10px;color:var(--text-tertiary);display:none;" id="shortcutsHint">Ctrl+K новый • Ctrl+, настройки • Ctrl+E файлы</div>
                    <div class="char-count" id="charCount">0 / 32000</div>
                </div>
            </div>
        </div>
    </div>

    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="close-modal">×</button>
        <img id="modalImage" src="" alt="">
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAQe5UUx7HkkF98Lo-j0KCufdPmQzzZySs",
            authDomain: "tanchiki-45b4e.firebaseapp.com",
            databaseURL: "https://tanchiki-45b4e-default-rtdb.firebaseio.com",
            projectId: "tanchiki-45b4e",
            storageBucket: "tanchiki-45b4e.firebasestorage.app",
            messagingSenderId: "152159817482",
            appId: "1:152159817482:web:a90141233e398ed633f4f3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const API_KEY = 'sk_MIrJoVngM6GGtVhfAbmYFlRvOAHCllqc';
        const API_BASE = 'https://gen.pollinations.ai';

        const SUPPORTED_EXTENSIONS = ['txt','md','json','js','ts','jsx','tsx','py','java','kt','swift','go','rs','rb','php','c','cpp','h','hpp','html','htm','css','scss','sass','less','xml','yaml','yml','toml','ini','cfg','conf','env','sh','bat','ps1','sql','lua','dart','vue','svelte','astro','makefile','dockerfile','gradle','properties','log','csv'];

        const MODEL_AVATARS = {
            google: `<svg viewBox="0 0 24 24" width="100%" height="100%"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>`,
            openai: `<svg viewBox="0 0 24 24" width="100%" height="100%"><path fill="currentColor" d="M22.28 9.77c.55-1.48.37-3.15-.5-4.53a5.14 5.14 0 0 0-5.55-2.42A5.2 5.2 0 0 0 12.34 1a5.18 5.18 0 0 0-4.95 3.63 5.14 5.14 0 0 0-3.44 2.5 5.2 5.2 0 0 0 .64 6.1A5.2 5.2 0 0 0 5.1 17.8a5.14 5.14 0 0 0 5.54 2.42 5.17 5.17 0 0 0 3.89 1.75 5.18 5.18 0 0 0 4.95-3.64 5.14 5.14 0 0 0 3.44-2.5 5.2 5.2 0 0 0-.64-6.1zM13.53 21.1a3.89 3.89 0 0 1-2.5-.9l.12-.07 4.15-2.4c.21-.12.34-.35.34-.6v-5.85l1.75 1.01c.02.01.03.03.04.05v4.85a3.92 3.92 0 0 1-3.9 3.91zm-8.4-3.59a3.87 3.87 0 0 1-.46-2.62l.12.07 4.15 2.4c.21.12.47.12.68 0l5.07-2.93v2.03c0 .02-.01.05-.03.06l-4.2 2.42a3.92 3.92 0 0 1-5.33-1.43zM3.64 8.65a3.87 3.87 0 0 1 2.04-1.72v4.94c0 .25.13.48.34.6l5.07 2.93-1.75 1.01a.08.08 0 0 1-.07.01l-4.2-2.42a3.92 3.92 0 0 1-1.43-5.35zm14.42 3.36-5.07-2.93 1.75-1.01c.02-.01.05-.02.07-.01l4.2 2.42a3.91 3.91 0 0 1-.6 7.05v-4.93a.7.7 0 0 0-.35-.59zm1.74-2.64-.12-.07-4.15-2.4a.68.68 0 0 0-.68 0l-5.07 2.93V7.8c0-.02.01-.05.03-.06l4.2-2.42a3.91 3.91 0 0 1 5.79 4.05zM9.67 12.87l-1.75-1.01a.08.08 0 0 1-.04-.05V6.96a3.91 3.91 0 0 1 6.41-3.02l-.12.07-4.15 2.4c-.21.12-.34.35-.34.6v5.86zm.95-2.06L12 10l1.38.8v1.6L12 13.2l-1.38-.8v-1.59z"/></svg>`,
            anthropic: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#CC785C"/><path fill="white" d="M15.5 5.5h-2.2l-1.4 4.3L10.5 5.5H8.3l2.5 7.2-2.7 7.8h2.2l1.6-4.8 1.6 4.8h2.2l-2.7-7.8 2.5-7.2z"/></svg>`,
            deepseek: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#4D6BFE"/><path fill="white" d="M6 8c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V8zm3 1v6h2v-2h2v2h2V9h-2v2h-2V9H9z"/></svg>`,
            mistral: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#F54E42"/><rect x="4" y="4" width="4" height="4" fill="#F2D117"/><rect x="10" y="4" width="4" height="4" fill="white"/><rect x="16" y="4" width="4" height="4" fill="#F2D117"/><rect x="4" y="10" width="4" height="4" fill="white"/><rect x="10" y="10" width="4" height="4" fill="white"/><rect x="16" y="10" width="4" height="4" fill="white"/><rect x="4" y="16" width="4" height="4" fill="#F2D117"/><rect x="10" y="16" width="4" height="4" fill="white"/><rect x="16" y="16" width="4" height="4" fill="#F2D117"/></svg>`,
            perplexity: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#1B1B1B"/><path fill="#20BBAD" d="M12 3l9 6v6l-9 6-9-6V9l9-6zm0 2.5L5.5 9.5v5l6.5 4 6.5-4v-5L12 5.5z"/><circle cx="12" cy="12" r="3" fill="#20BBAD"/></svg>`,
            qwen: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#615EFF"/><circle cx="12" cy="12" r="7" fill="none" stroke="white" stroke-width="2"/><path fill="white" d="M12 7v5l3 3"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
            kimi: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#000"/><path fill="#4ECDC4" d="M12 4c4.4 0 8 3.6 8 8s-3.6 8-8 8-8-3.6-8-8 3.6-8 8-8zm0 2c-3.3 0-6 2.7-6 6s2.7 6 6 6c1.4 0 2.8-.5 3.8-1.4-.6.2-1.2.4-1.8.4-3.3 0-6-2.7-6-6 0-1.4.5-2.8 1.4-3.8-.2.6-.4 1.2-.4 1.8 0 2.2 1.8 4 4 4s4-1.8 4-4c0-.6-.2-1.2-.4-1.8.9 1 1.4 2.4 1.4 3.8 0 3.3-2.7 6-6 6z"/></svg>`,
            glm: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#1A73E8"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="9" font-weight="bold" font-family="Arial">GLM</text></svg>`,
            minimax: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#5046E4"/><path fill="white" d="M6 8h3v8H6V8zm4.5 0H14l1.5 4V8h3v8h-3l-2-5.5V16h-3V8z"/></svg>`,
            xai: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#000"/><path fill="white" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`,
            amazon: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#232F3E"/><path fill="#FF9900" d="M6.5 14.5c2.5 2 6.5 3 9.5 1.5M17.5 17l-1.5-1 1-1"/><path fill="#FF9900" d="M12 6c-3 0-5.5 2-6 5 0 0 1.5-2 4-2s4 1.5 4 3.5c0 1.5-1 2.5-2 2.5s-2-1-2-2c0-.5.5-1 1-1"/></svg>`,
            chickytutor: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#FFD54F"/><ellipse cx="12" cy="14" rx="6" ry="5" fill="#FFECB3"/><circle cx="9" cy="12" r="1.5" fill="#333"/><circle cx="15" cy="12" r="1.5" fill="#333"/><path fill="#FF9800" d="M12 14l-2 3h4l-2-3z"/></svg>`,
            midijourney: `<svg viewBox="0 0 24 24" width="100%" height="100%"><defs><linearGradient id="midiGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#9C27B0"/><stop offset="100%" style="stop-color:#E91E63"/></linearGradient></defs><rect width="24" height="24" rx="4" fill="url(#midiGrad)"/><rect x="4" y="8" width="3" height="12" rx="1" fill="white"/><rect x="8" y="8" width="3" height="12" rx="1" fill="white"/><rect x="13" y="8" width="3" height="12" rx="1" fill="white"/><rect x="17" y="8" width="3" height="12" rx="1" fill="white"/><rect x="5.5" y="8" width="2" height="7" rx="0.5" fill="#333"/><rect x="10" y="8" width="2" height="7" rx="0.5" fill="#333"/><rect x="15" y="8" width="2" height="7" rx="0.5" fill="#333"/><path d="M4 6c0-1.1.9-2 2-2h12a2 2 0 012 2v2H4V6z" fill="rgba(255,255,255,0.3)"/></svg>`,
            nomnom: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#E91E63"/><circle cx="8" cy="10" r="2" fill="white"/><circle cx="16" cy="10" r="2" fill="white"/><path fill="white" d="M7 14c0 0 2.5 4 5 4s5-4 5-4H7z"/></svg>`,
            seedream: `<svg viewBox="0 0 24 24" width="100%" height="100%"><defs><linearGradient id="seedreamGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#11998e"/><stop offset="100%" style="stop-color:#38ef7d"/></linearGradient></defs><rect width="24" height="24" rx="4" fill="url(#seedreamGrad)"/><circle cx="12" cy="12" r="5" fill="white" opacity="0.9"/><circle cx="12" cy="12" r="2" fill="#11998e"/></svg>`,
            gptimage: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#10A37F"/><path fill="white" d="M12 4l7 4v8l-7 4-7-4V8l7-4zm0 2.5L7.5 9v6l4.5 2.5 4.5-2.5V9L12 6.5z"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
            video: `<svg viewBox="0 0 24 24" width="100%" height="100%"><defs><linearGradient id="videoGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f093fb"/><stop offset="100%" style="stop-color:#f5576c"/></linearGradient></defs><rect width="24" height="24" rx="4" fill="url(#videoGrad)"/><rect x="4" y="7" width="16" height="10" rx="2" fill="white" opacity="0.9"/><path fill="#f5576c" d="M10 10v4l4-2-4-2z"/></svg>`,
            flux: `<svg viewBox="0 0 24 24" width="100%" height="100%"><defs><linearGradient id="fluxGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#667eea"/><stop offset="50%" style="stop-color:#764ba2"/><stop offset="100%" style="stop-color:#f093fb"/></linearGradient></defs><rect width="24" height="24" rx="4" fill="url(#fluxGrad)"/><path fill="white" d="M7 7h4v4H7V7zm6 0h4v4h-4V7zm-6 6h4v4H7v-4zm6 0h4v4h-4v-4z" opacity="0.9"/></svg>`,
            default: `<svg viewBox="0 0 24 24" width="100%" height="100%"><rect width="24" height="24" rx="4" fill="#6B7280"/><circle cx="12" cy="10" r="4" fill="white"/><path fill="white" d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>`
        };

        function getModelAvatar(modelId) {
            if (modelId.includes('gemini')) return MODEL_AVATARS.google;
            if (modelId.includes('openai') || modelId.includes('gpt')) return MODEL_AVATARS.openai;
            if (modelId.includes('claude')) return MODEL_AVATARS.anthropic;
            if (modelId.includes('grok')) return MODEL_AVATARS.xai;
            if (modelId.includes('nova')) return MODEL_AVATARS.amazon;
            if (modelId.includes('deepseek')) return MODEL_AVATARS.deepseek;
            if (modelId.includes('mistral')) return MODEL_AVATARS.mistral;
            if (modelId.includes('perplexity')) return MODEL_AVATARS.perplexity;
            if (modelId.includes('qwen')) return MODEL_AVATARS.qwen;
            if (modelId.includes('kimi')) return MODEL_AVATARS.kimi;
            if (modelId.includes('glm')) return MODEL_AVATARS.glm;
            if (modelId.includes('minimax')) return MODEL_AVATARS.minimax;
            if (modelId.includes('chickytutor')) return MODEL_AVATARS.chickytutor;
            if (modelId.includes('midijourney')) return MODEL_AVATARS.midijourney;
            if (modelId.includes('nomnom')) return MODEL_AVATARS.nomnom;
            if (modelId.includes('flux') || modelId.includes('klein') || modelId.includes('zimage')) return MODEL_AVATARS.flux;
            if (modelId.includes('seedream') || modelId.includes('seedance')) return MODEL_AVATARS.seedream;
            if (modelId.includes('gptimage') || modelId.includes('nanobanana') || modelId.includes('kontext')) return MODEL_AVATARS.gptimage;
            if (modelId.includes('wan') || modelId.includes('veo')) return MODEL_AVATARS.video;
            return MODEL_AVATARS.default;
        }

        const MODELS = {
            text: {
                fast: [
                    { id: 'nova-fast', name: 'Amazon Nova Micro', desc: '26.3K ответов', caps: [] },
                    { id: 'qwen-coder', name: 'Qwen3 Coder 30B', desc: '8.8K ответов', caps: [], isNew: true },
                    { id: 'gemini-fast', name: 'Gemini 2.5 Flash Lite', desc: '3.4K ответов', caps: ['vision', 'search', 'code'] },
                    { id: 'mistral', name: 'Mistral Small 3.2 24B', desc: '2.6K ответов', caps: [] },
                    { id: 'openai-fast', name: 'GPT-5 Nano', desc: '700 ответов', caps: ['vision'] }
                ],
                standard: [
                    { id: 'grok', name: 'xAI Grok 4 Fast', desc: '900 ответов', caps: [] },
                    { id: 'openai', name: 'GPT-5 Mini', desc: '850 ответов', caps: ['vision'] },
                    { id: 'perplexity-fast', name: 'Perplexity Sonar', desc: '550 ответов', caps: ['search'] },
                    { id: 'deepseek', name: 'DeepSeek V3.2', desc: '500 ответов', caps: ['reasoning'] },
                    { id: 'gemini-search', name: 'Gemini 3 Flash', desc: '250 ответов', caps: ['vision', 'search', 'code'] },
                    { id: 'openai-audio', name: 'GPT-4o Mini Audio', desc: '200 ответов', caps: ['vision'] },
                    { id: 'gemini', name: 'Gemini 3 Flash', desc: '150 ответов', caps: ['vision', 'search', 'code'] }
                ],
                reasoning: [
                    { id: 'perplexity-reasoning', name: 'Perplexity Sonar Reasoning', desc: '150 ответов', caps: ['reasoning', 'search'] },
                    { id: 'kimi', name: 'Moonshot Kimi K2 Thinking', desc: '100 ответов', caps: ['reasoning'] },
                    { id: 'glm', name: 'Z.ai GLM-4.7', desc: '85 ответов', caps: ['reasoning'], isNew: true },
                    { id: 'minimax', name: 'MiniMax M2.1', desc: '85 ответов', caps: ['reasoning'], isNew: true }
                ],
                premium: [
                    { id: 'openai-large', name: 'OpenAI GPT-5.2', desc: '65 ответов', caps: ['vision', 'reasoning', 'search', 'code'] },
                    { id: 'claude-fast', name: 'Anthropic Claude Haiku 4.5', desc: '55 ответов', caps: ['vision'] },
                    { id: 'gemini-legacy', name: 'Google Gemini 2.5 Pro', desc: '30 ответов', caps: ['vision', 'reasoning', 'search', 'code'] },
                    { id: 'claude', name: 'Anthropic Claude Sonnet 4.5', desc: '25 ответов', caps: ['vision', 'reasoning', 'code'] },
                    { id: 'gemini-large', name: 'Google Gemini 3 Pro', desc: '25 ответов', caps: ['vision', 'reasoning', 'search', 'code'] },
                    { id: 'claude-large', name: 'Anthropic Claude Opus 4.5', desc: '15 ответов', caps: ['vision', 'reasoning', 'search', 'code'] }
                ],
                special: [
                    { id: 'chickytutor', name: 'ChickyTutor AI', desc: 'Language Tutor', caps: [] },
                    { id: 'midijourney', name: 'MIDIjourney', desc: 'Music AI', caps: [] },
                    { id: 'nomnom', name: 'NomNom', desc: 'by @Itachi-1824', caps: ['search'], isNew: true }
                ]
            },
            image: {
                fast: [
                    { id: 'flux', name: 'Flux Schnell', desc: '5K images', caps: [] },
                    { id: 'zimage', name: 'Z-Image Turbo', desc: '5K images', caps: [] },
                    { id: 'turbo', name: 'SDXL Turbo', desc: '3.3K images', caps: [] }
                ],
                advanced: [
                    { id: 'klein', name: 'FLUX.2 Klein 4B', desc: '150 images', caps: ['vision'], isNew: true },
                    { id: 'klein-large', name: 'FLUX.2 Klein 9B', desc: '85 images', caps: ['vision'], isNew: true },
                    { id: 'gptimage', name: 'GPT Image 1 Mini', desc: '75 images', caps: ['vision'] },
                    { id: 'seedream', name: 'Seedream 4.0', desc: '35 images', caps: ['vision'] },
                    { id: 'kontext', name: 'FLUX.1 Kontext', desc: '25 images', caps: ['vision'] },
                    { id: 'nanobanana', name: 'NanoBanana', desc: '25 images', caps: ['vision'] },
                    { id: 'seedream-pro', name: 'Seedream 4.5 Pro', desc: '25 images', caps: ['vision'] },
                    { id: 'gptimage-large', name: 'GPT Image 1.5', desc: '10 images', caps: ['vision'] },
                    { id: 'nanobanana-pro', name: 'NanoBanana Pro', desc: '6 images', caps: ['vision'] }
                ]
            },
            video: {
                alpha: [
                    { id: 'seedance-pro', name: 'Seedance Pro-Fast', desc: '10 videos', caps: ['vision'] },
                    { id: 'seedance', name: 'Seedance Lite', desc: '6 videos', caps: ['vision'] },
                    { id: 'wan', name: 'Wan 2.6', desc: '6 videos', caps: ['vision'], isNew: true },
                    { id: 'veo', name: 'Veo 3.1 Fast', desc: '1 video', caps: ['vision'] }
                ]
            }
        };

        let currentModel = { id: 'gemini', name: 'Gemini 3 Flash', type: 'text', caps: ['vision', 'search', 'code'] };
        let conversationHistory = [];
        let attachedImages = [];
        let attachedFiles = [];
        let isGenerating = false;
        let abortController = null;
        let chatId = null;
        let generationStartTime = 0;
        
        // Virtual File System
        let virtualFS = {};
        let currentPreviewFile = null;
        
        // Auth state
        let currentUser = null;
        let useCloudSync = false;
        
        // Telegram auth callback
        function onTelegramAuth(user) {
            currentUser = user;
            currentUser.photoUrl = user.photo_url || '';
            useCloudSync = true;
            localStorage.setItem('telegramUser', JSON.stringify(currentUser));
            
            // Save user to Firebase
            db.ref('users/' + user.id).set({
                id: user.id,
                first_name: user.first_name,
                last_name: user.last_name || '',
                username: user.username || '',
                photo_url: user.photo_url || '',
                auth_date: user.auth_date,
                lastLogin: Date.now()
            });
            
            // Migrate local chats to cloud
            migrateLocalChatsToCloud();
            
            updateAuthUI();
            updateWelcomeGreeting();
            showToast('✅ Вы вошли как ' + user.first_name);
        }
        
        function migrateLocalChatsToCloud() {
            if (!currentUser) return;
            const localChats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            if (localChats.length > 0) {
                localChats.forEach(chat => {
                    const newRef = db.ref('users/' + currentUser.id + '/chats').push();
                    db.ref('users/' + currentUser.id + '/chats/' + newRef.key).set({
                        ...chat,
                        migratedAt: Date.now()
                    });
                });
                showToast('☁️ ' + localChats.length + ' чатов синхронизировано');
            }
        }
        
        function logoutUser() {
            currentUser = null;
            useCloudSync = false;
            localStorage.removeItem('telegramUser');
            updateAuthUI();
            loadChatHistory();
            showToast('👋 Вы вышли из аккаунта');
        }
        
        function updateAuthUI() {
            const notLoggedIn = document.getElementById('authNotLoggedIn');
            const loggedIn = document.getElementById('authLoggedIn');
            const userName = document.getElementById('authUserName');
            const userInfo = document.getElementById('authUserInfo');
            const syncStatus = document.getElementById('syncStatus');
            
            if (currentUser) {
                notLoggedIn.style.display = 'none';
                loggedIn.style.display = 'block';
                userName.textContent = '👤 ' + currentUser.first_name + (currentUser.last_name ? ' ' + currentUser.last_name : '');
                userInfo.textContent = currentUser.username ? '@' + currentUser.username + ' • Синхронизация ☁️' : 'Синхронизация включена ☁️';
                syncStatus.textContent = '☁️';
                syncStatus.title = 'Синхронизация включена';
            } else {
                notLoggedIn.style.display = 'block';
                loggedIn.style.display = 'none';
                syncStatus.textContent = '';
                // Initialize Telegram widget
                initTelegramWidget();
            }
        }
        
        function initTelegramWidget() {
            // Domain: https://VriskasYT.github.io/Ai
            const container = document.getElementById('telegramLoginWidget');
            if (container && !container.hasChildNodes()) {
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://telegram.org/js/telegram-widget.js?22';
                script.setAttribute('data-telegram-login', 'VriskasHelperBot');
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                script.setAttribute('data-request-access', 'write');
                container.appendChild(script);
            }
        }

        const CODE_MODE_PROMPT = `ТЫ - ОПЫТНЫЙ ПРОГРАММИСТ. СТРОГО СЛЕДУЙ ПРАВИЛАМ!

## ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА:
1. ВСЕГДА используй XML теги для ЛЮБЫХ файловых операций
2. ПИШИ ПОЛНЫЙ КОД - НИКОГДА не сокращай, не пропускай, не пиши "..." или "остальной код"
3. ВСЁ В ОДНОМ HTML ФАЙЛЕ - CSS и JavaScript внутри HTML
4. Проверяй синтаксис перед отправкой
5. Пиши аккуратно, не пропускай буквы и символы

## FILE OPERATION TAGS (MANDATORY)

### Creating files:
<create_file path="filename.ext">
COMPLETE FILE CONTENT - NEVER ABBREVIATE
</create_file>

### Editing files:
<edit_file path="filename.ext">
<old>exact text to find</old>
<new>replacement text</new>
</edit_file>

### Reading files:
<read_file path="filename.ext"/>

### Deleting files:
<delete_file path="filename.ext"/>

### Renaming files:
<rename_file old_path="old.txt" new_path="new.txt"/>

### Copying files:
<copy_file src="source.txt" dest="destination.txt"/>

### Moving files:
<move_file src="old/path.txt" dest="new/path.txt"/>

### Listing directory:
<list_files path="./"/>

### Running/executing file:
<run_file path="script.js"/>

### Deploying file:
<deploy_file path="index.html"/>

### Search in files:
<search_in_file path="*.js" query="functionName"/>

### Show file diff:
<diff_file path="file.txt"/>

### Create directory:
<create_dir path="new_folder/"/>

### Install package:
<install_package name="lodash"/>

### Run command:
<run_command cmd="npm install"/>

### Download file:
<download_file url="https://example.com/file.zip" path="file.zip"/>

### Append to file:
<append_file path="log.txt">
New content to append
</append_file>

### Insert at line:
<insert_at_line path="file.txt" line="5">
Content to insert at line 5
</insert_at_line>

## CRITICAL RULES:
1. ALWAYS use file operation tags when writing ANY code or creating files
2. Include COMPLETE code - never abbreviate or say "rest of code here"
3. For web projects: ALWAYS create ONE SINGLE HTML file with embedded CSS and JavaScript
4. NEVER create separate .css or .js files - put everything in ONE HTML file
5. Explain what you're doing BEFORE each operation
6. After creating files, explain how to use them
7. Write in user's language (Russian if they write in Russian)
8. Make the code visually beautiful with modern CSS styling

Example for "create snake game":
I'll create a Snake game.

<create_file path="snake.html">
<!DOCTYPE html>
<html>
...complete code...
</html>
</create_file>

Open snake.html in browser to play!`;

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            buildModelList();
            updateToggleStates();
            updateActiveFeatures();
            updateAttachButtons();
            updateLogo();
            loadChatHistory();
            updateWelcomeGreeting();
            
            document.getElementById('messageInput').addEventListener('input', function() {
                document.getElementById('sendBtn').disabled = !this.value.trim() && !attachedImages.length && !attachedFiles.length;
            });

            document.getElementById('messages').addEventListener('scroll', function() {
                const isNearBottom = this.scrollHeight - this.scrollTop - this.clientHeight < 100;
                document.getElementById('scrollBottomBtn').classList.toggle('show', !isNearBottom);
            });
        });

        function updateLogo() {
            document.getElementById('headerLogo').innerHTML = getModelAvatar(currentModel.id);
            document.getElementById('welcomeLogo').innerHTML = getModelAvatar(currentModel.id);
        }

        function loadSettings() {
            // Check for saved Telegram user
            try {
                const savedUser = localStorage.getItem('telegramUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    useCloudSync = true;
                }
            } catch {}
            
            updateAuthUI();
            
            if (localStorage.getItem('darkTheme') === 'true') {
                document.body.classList.add('dark-theme');
                document.getElementById('darkThemeToggle').checked = true;
            }
            try {
                const saved = localStorage.getItem('currentModel');
                if (saved) {
                    currentModel = JSON.parse(saved);
                    // Update caps from current model definitions
                    for (const [type, subcats] of Object.entries(MODELS)) {
                        for (const [subcat, models] of Object.entries(subcats)) {
                            const found = models.find(m => m.id === currentModel.id);
                            if (found) {
                                currentModel.caps = found.caps;
                                currentModel.type = type;
                                break;
                            }
                        }
                    }
                    document.getElementById('selectedModelName').textContent = currentModel.name;
                }
            } catch {}
            
            // Load settings from localStorage (default)
            const localSettings = JSON.parse(localStorage.getItem('settings') || '{}');
            if (localSettings.systemPrompt) document.getElementById('systemPrompt').value = localSettings.systemPrompt;
            if (localSettings.temperature) {
                document.getElementById('temperatureSlider').value = localSettings.temperature;
                updateTempValue();
            }
            if (localSettings.maxTokens) {
                document.getElementById('tokensSlider').value = localSettings.maxTokens;
                updateTokensValue();
            }
            if (localSettings.streaming !== undefined) document.getElementById('streamingToggle').checked = localSettings.streaming;
            if (localSettings.autoScroll !== undefined) document.getElementById('autoScrollToggle').checked = localSettings.autoScroll;
            
            // If logged in, also sync from Firebase
            if (currentUser && useCloudSync) {
                db.ref('users/' + currentUser.id + '/settings').once('value', snap => {
                    const data = snap.val() || {};
                    if (data.systemPrompt) document.getElementById('systemPrompt').value = data.systemPrompt;
                    if (data.temperature) {
                        document.getElementById('temperatureSlider').value = data.temperature;
                        updateTempValue();
                    }
                    if (data.maxTokens) {
                        document.getElementById('tokensSlider').value = data.maxTokens;
                        updateTokensValue();
                    }
                });
            }
        }

        function toggleDarkTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('darkTheme', document.body.classList.contains('dark-theme'));
        }

        function updateTempValue() { document.getElementById('tempValue').textContent = document.getElementById('temperatureSlider').value; }
        function updateTokensValue() { 
            const val = parseInt(document.getElementById('tokensSlider').value);
            document.getElementById('tokensValue').textContent = val >= 16384 ? '∞ Неограничено' : val; 
        }

        function buildModelList() {
            const container = document.getElementById('modelList');
            let html = '';
            const cats = {
                text: { fast: '💬 Быстрые', standard: '💬 Стандартные', reasoning: '🧠 Reasoning', premium: '💎 Премиум', special: '✨ Специальные' },
                image: { fast: '🖼️ Быстрые', advanced: '🖼️ Продвинутые' },
                video: { alpha: '🎬 Видео (alpha)' }
            };
            for (const [type, subcats] of Object.entries(MODELS)) {
                for (const [subcat, models] of Object.entries(subcats)) {
                    html += `<div class="model-category">${cats[type][subcat]}</div>`;
                    for (const m of models) {
                        const sel = m.id === currentModel.id ? 'selected' : '';
                        const badges = [];
                        if (m.isNew) badges.push('<span class="badge new">NEW</span>');
                        if (m.caps.includes('vision')) badges.push('<span class="badge vision">👁️</span>');
                        if (m.caps.includes('search')) badges.push('<span class="badge search">🔍</span>');
                        if (m.caps.includes('reasoning')) badges.push('<span class="badge reasoning">🧠</span>');
                        if (m.caps.includes('code')) badges.push('<span class="badge code">💻</span>');
                        html += `<div class="model-option ${sel}" data-id="${m.id}" data-name="${m.name}" data-type="${type}" data-caps='${JSON.stringify(m.caps)}' onclick="selectModel(this)"><div class="model-option-avatar">${getModelAvatar(m.id)}</div><div class="model-info"><div class="model-name">${m.name}</div><div class="model-desc">${m.desc}</div></div><div class="model-badges">${badges.join('')}</div></div>`;
                    }
                }
            }
            container.innerHTML = html;
        }

        function filterModels() {
            const q = document.getElementById('modelSearchInput').value.toLowerCase();
            document.querySelectorAll('.model-option').forEach(el => el.classList.toggle('hidden', !el.dataset.name.toLowerCase().includes(q)));
        }

        function selectModel(el) {
            document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            currentModel = { id: el.dataset.id, name: el.dataset.name, type: el.dataset.type, caps: JSON.parse(el.dataset.caps) };
            document.getElementById('selectedModelName').textContent = currentModel.name;
            localStorage.setItem('currentModel', JSON.stringify(currentModel));
            updateToggleStates();
            updateActiveFeatures();
            updateAttachButtons();
            updateLogo();
            toggleModelDropdown();
        }

        function toggleModelDropdown() {
            const dd = document.getElementById('modelDropdown');
            const btn = document.getElementById('modelBtn');
            const open = dd.classList.toggle('show');
            btn.classList.toggle('open', open);
            if (open) document.getElementById('modelSearchInput').focus();
        }

        function updateToggleStates() {
            const caps = currentModel.caps || [];
            const rAvail = caps.includes('reasoning'), sAvail = caps.includes('search'), cAvail = caps.includes('code'), vAvail = caps.includes('vision') || currentModel.type !== 'text';
            document.getElementById('reasoningToggle').disabled = !rAvail;
            document.getElementById('searchToggle').disabled = !sAvail;
            document.getElementById('codeExecToggle').disabled = !cAvail;
            document.getElementById('visionToggle').disabled = !vAvail;
            document.getElementById('reasoningStatus').textContent = rAvail ? 'Доступно' : 'Недоступно';
            document.getElementById('reasoningStatus').className = 'setting-status ' + (rAvail ? 'active' : 'unavailable');
            document.getElementById('searchStatus').textContent = sAvail ? 'Доступно' : 'Недоступно';
            document.getElementById('searchStatus').className = 'setting-status ' + (sAvail ? 'active' : 'unavailable');
            document.getElementById('codeStatus').textContent = cAvail ? 'Доступно' : 'Недоступно';
            document.getElementById('codeStatus').className = 'setting-status ' + (cAvail ? 'active' : 'unavailable');
            document.getElementById('visionStatus').textContent = vAvail ? 'Доступно' : 'Недоступно';
            document.getElementById('visionStatus').className = 'setting-status ' + (vAvail ? 'active' : 'unavailable');
            if (!rAvail) document.getElementById('reasoningToggle').checked = false;
            if (!sAvail) document.getElementById('searchToggle').checked = false;
            if (!cAvail) document.getElementById('codeExecToggle').checked = false;
            if (!vAvail) document.getElementById('visionToggle').checked = false;
        }

        function updateAttachButtons() {
            const modelSupportsVision = currentModel.caps?.includes('vision') || currentModel.type !== 'text';
            const visionEnabled = document.getElementById('visionToggle').checked;
            // Hide image button if model doesn't support vision OR if vision is disabled in settings
            const showImageBtn = modelSupportsVision && (visionEnabled || document.getElementById('visionToggle').disabled);
            document.getElementById('imageAttachBtn').classList.toggle('hidden', !showImageBtn);
        }

        function updateActiveFeatures() {
            const f = [];
            if (document.getElementById('streamingToggle').checked) f.push('<span class="feature-pill streaming">⚡ Стрим</span>');
            if (document.getElementById('reasoningToggle').checked && !document.getElementById('reasoningToggle').disabled) f.push('<span class="feature-pill reasoning">🧠 Думать</span>');
            if (document.getElementById('searchToggle').checked && !document.getElementById('searchToggle').disabled) f.push('<span class="feature-pill search">🔍 Поиск</span>');
            if (document.getElementById('codeExecToggle').checked && !document.getElementById('codeExecToggle').disabled) f.push('<span class="feature-pill code">💻 Код</span>');
            if (document.getElementById('visionToggle').checked && !document.getElementById('visionToggle').disabled) f.push('<span class="feature-pill vision">👁️ Vision</span>');
            document.getElementById('activeFeatures').innerHTML = f.join('');
        }

        function toggleSettings() {
            const p = document.getElementById('settingsPanel'), o = document.getElementById('overlay');
            const btn = document.querySelector('.header-right .icon-btn:last-child');
            const open = p.classList.toggle('open');
            o.classList.toggle('show', open);
            // Animate settings icon
            if (btn) {
                btn.classList.add('settings-rotating');
                setTimeout(() => btn.classList.remove('settings-rotating'), 500);
            }
            // Save settings when closing
            if (!open) {
                const settings = {
                    systemPrompt: document.getElementById('systemPrompt').value,
                    temperature: document.getElementById('temperatureSlider').value,
                    maxTokens: document.getElementById('tokensSlider').value,
                    streaming: document.getElementById('streamingToggle').checked,
                    autoScroll: document.getElementById('autoScrollToggle').checked
                };
                // Always save to localStorage
                localStorage.setItem('settings', JSON.stringify(settings));
                
                // If logged in, also save to Firebase
                if (currentUser && useCloudSync) {
                    db.ref('users/' + currentUser.id + '/settings').update(settings);
                }
            }
        }

        function toggleHistory() {
            const p = document.getElementById('historyPanel'), o = document.getElementById('overlay');
            const open = !p.style.left || p.style.left === '-100%';
            p.style.left = open ? '0' : '-100%';
            o.classList.toggle('show', open);
        }

        function closeAllPanels() {
            document.getElementById('settingsPanel').classList.remove('open');
            document.getElementById('historyPanel').style.left = '-100%';
            document.getElementById('fileExplorer').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('modelDropdown').classList.remove('show');
            document.getElementById('modelBtn').classList.remove('open');
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.model-selector') && !e.target.closest('.model-dropdown')) {
                document.getElementById('modelDropdown').classList.remove('show');
                document.getElementById('modelBtn').classList.remove('open');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            // Ctrl+K - new chat
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                newChat();
            }
            // Ctrl+, - settings
            if (e.ctrlKey && e.key === ',') {
                e.preventDefault();
                toggleSettings();
            }
            // Ctrl+H - history
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                toggleHistory();
            }
            // Ctrl+E - file explorer
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                toggleFileExplorer();
            }
            // Escape - close panels
            if (e.key === 'Escape') {
                closeAllPanels();
                closeFilePreview();
                closeImageModal();
            }
        });

        function newChat() {
            chatId = null;
            conversationHistory = [];
            attachedImages = [];
            attachedFiles = [];
            virtualFS = {};
            renderFileExplorer();
            
            const messagesWrapper = document.getElementById('messagesWrapper');
            const welcomeScreen = document.getElementById('welcomeScreen');
            
            // Animate transition
            if (!messagesWrapper.classList.contains('hidden')) {
                messagesWrapper.style.opacity = '0';
                messagesWrapper.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    document.getElementById('messages').innerHTML = '';
                    messagesWrapper.classList.add('hidden');
                    messagesWrapper.style.opacity = '';
                    messagesWrapper.style.transform = '';
                    welcomeScreen.classList.remove('hidden', 'hiding');
                    welcomeScreen.style.animation = 'fadeIn 0.3s ease-out';
                }, 200);
            } else {
                document.getElementById('messages').innerHTML = '';
                welcomeScreen.classList.remove('hidden', 'hiding');
            }
            
            document.getElementById('newChatBtn').style.display = 'none';
            document.getElementById('messageInput').value = '';
            document.getElementById('attachedFiles').innerHTML = '';
            document.getElementById('charCount').textContent = '0 / 32000';
            document.getElementById('sendBtn').disabled = true;
            closeAllPanels();
        }

        function useSuggestion(t) { document.getElementById('messageInput').value = t; document.getElementById('sendBtn').disabled = false; sendMessage(); }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
        function updateCharCount() { document.getElementById('charCount').textContent = `${document.getElementById('messageInput').value.length.toLocaleString()} / 32,000`; }

        function handleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!document.getElementById('sendBtn').disabled && !isGenerating) sendMessage(); }
        }

        function handleSendClick() { if (isGenerating) stopGeneration(); else sendMessage(); }

        let lastPendingOps = [];
        
        function stopGeneration() { 
            if (abortController) { 
                abortController.abort(); 
                abortController = null; 
                // Update pending ops to show "stopped"
                if (lastPendingOps.length) {
                    const contentEl = document.querySelector('.message.assistant:last-child .message-content');
                    if (contentEl) {
                        const pendingBlocks = contentEl.querySelectorAll('.file-op-pending');
                        pendingBlocks.forEach(block => {
                            block.classList.remove('file-op-pending');
                            block.classList.add('file-op-stopped');
                            const status = block.querySelector('.file-op-status');
                            if (status) {
                                const indicator = status.querySelector('.file-op-indicator');
                                if (indicator) indicator.textContent = '⏹️ Остановлено';
                                const progress = status.querySelector('.file-op-progress');
                                if (progress) progress.remove();
                            }
                        });
                    }
                }
            } 
            isGenerating = false; 
            updateSendButton(); 
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn'), si = document.getElementById('sendIcon'), sti = document.getElementById('stopIcon');
            if (isGenerating) { btn.classList.add('stop-btn'); btn.disabled = false; si.style.display = 'none'; sti.style.display = 'block'; }
            else { btn.classList.remove('stop-btn'); si.style.display = 'block'; sti.style.display = 'none'; btn.disabled = !document.getElementById('messageInput').value.trim() && !attachedImages.length && !attachedFiles.length; }
        }

        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(f => {
                if (f.size > 20*1024*1024) { showToast('❌ Файл слишком большой (макс 20MB)'); return; }
                const r = new FileReader();
                r.onload = ev => { if (ev.target?.result) { attachedImages.push({ name: f.name, data: ev.target.result, size: formatFileSize(f.size) }); renderAttachedFiles(); document.getElementById('sendBtn').disabled = false; } };
                r.readAsDataURL(f);
            });
            e.target.value = '';
        }

        function handleFileUpload(e) {
            Array.from(e.target.files).forEach(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                if (!SUPPORTED_EXTENSIONS.includes(ext)) { showToast(`❌ Формат .${ext} не поддерживается`); return; }
                const r = new FileReader();
                r.onload = ev => { if (ev.target?.result) { attachedFiles.push({ name: f.name, content: ev.target.result, size: formatFileSize(f.size), type: ext.toUpperCase() }); renderAttachedFiles(); document.getElementById('sendBtn').disabled = false; } };
                r.onerror = () => showToast('❌ Ошибка чтения файла');
                r.readAsText(f);
            });
            e.target.value = '';
        }

        function formatFileSize(b) { if (b < 1024) return b + ' B'; if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB'; return (b/(1024*1024)).toFixed(1) + ' MB'; }

        function renderAttachedFiles() {
            const c = document.getElementById('attachedFiles');
            let h = attachedImages.map((img, i) => `<div class="attached-file image"><img src="${img.data}" alt="${img.name}"><button class="remove-btn" onclick="removeAttachedImage(${i})">×</button></div>`).join('');
            h += attachedFiles.map((f, i) => `<div class="attached-file document"><span>📄</span><div style="flex:1;min-width:0"><div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div><div style="font-size:11px;color:var(--text-tertiary)">${f.size}</div></div><button class="remove-btn" onclick="removeAttachedFile(${i})" style="position:relative">×</button></div>`).join('');
            c.innerHTML = h;
        }

        function removeAttachedImage(i) { attachedImages.splice(i, 1); renderAttachedFiles(); checkSendButton(); }
        function removeAttachedFile(i) { attachedFiles.splice(i, 1); renderAttachedFiles(); checkSendButton(); }
        function checkSendButton() { document.getElementById('sendBtn').disabled = !document.getElementById('messageInput').value.trim() && !attachedImages.length && !attachedFiles.length; }
        function scrollToBottom() { document.getElementById('messages').scrollTo({ top: document.getElementById('messages').scrollHeight, behavior: 'smooth' }); }

        function escapeHtml(t) { return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

        function parseFileOperations(rawText) {
            const ops = [];
            let m;
            // create_file
            const createRe = /<create_file\s+path=["']([^"']+)["']>([\s\S]*?)<\/create_file>/gi;
            while ((m = createRe.exec(rawText)) !== null) ops.push({ type: 'CREATE', icon: '📄', path: m[1], content: m[2].trim(), status: 'Создан' });
            // edit_file
            const editRe = /<edit_file\s+path=["']([^"']+)["']>\s*<old>([\s\S]*?)<\/old>\s*<new>([\s\S]*?)<\/new>\s*<\/edit_file>/gi;
            while ((m = editRe.exec(rawText)) !== null) ops.push({ type: 'EDIT', icon: '✏️', path: m[1], content: `--- OLD ---\n${m[2].trim()}\n\n+++ NEW +++\n${m[3].trim()}`, status: 'Изменён' });
            // read_file
            const readRe = /<read_file\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = readRe.exec(rawText)) !== null) ops.push({ type: 'READ', icon: '👁️', path: m[1], content: '', status: 'Прочитан' });
            // delete_file
            const delRe = /<delete_file\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = delRe.exec(rawText)) !== null) ops.push({ type: 'DELETE', icon: '🗑️', path: m[1], content: '', status: 'Удалён' });
            // rename_file
            const renameRe = /<rename_file\s+old_path=["']([^"']+)["']\s+new_path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = renameRe.exec(rawText)) !== null) ops.push({ type: 'RENAME', icon: '📝', path: `${m[1]} → ${m[2]}`, content: '', status: 'Переименован' });
            // copy_file
            const copyRe = /<copy_file\s+src=["']([^"']+)["']\s+dest=["']([^"']+)["']\s*\/?>/gi;
            while ((m = copyRe.exec(rawText)) !== null) ops.push({ type: 'COPY', icon: '📋', path: `${m[1]} → ${m[2]}`, content: '', status: 'Скопирован' });
            // move_file
            const moveRe = /<move_file\s+src=["']([^"']+)["']\s+dest=["']([^"']+)["']\s*\/?>/gi;
            while ((m = moveRe.exec(rawText)) !== null) ops.push({ type: 'MOVE', icon: '📦', path: `${m[1]} → ${m[2]}`, content: '', status: 'Перемещён' });
            // list_files
            const listRe = /<list_files\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = listRe.exec(rawText)) !== null) ops.push({ type: 'LIST', icon: '📂', path: m[1], content: '', status: 'Список' });
            // run_file
            const runRe = /<run_file\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = runRe.exec(rawText)) !== null) ops.push({ type: 'RUN', icon: '▶️', path: m[1], content: '', status: 'Выполнен' });
            // deploy_file
            const deployRe = /<deploy_file\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = deployRe.exec(rawText)) !== null) ops.push({ type: 'DEPLOY', icon: '🚀', path: m[1], content: '', status: 'Развёрнут' });
            // search_in_file
            const searchRe = /<search_in_file\s+path=["']([^"']+)["']\s+query=["']([^"']+)["']\s*\/?>/gi;
            while ((m = searchRe.exec(rawText)) !== null) ops.push({ type: 'SEARCH', icon: '🔍', path: `${m[1]} : "${m[2]}"`, content: '', status: 'Найдено' });
            // diff_file
            const diffRe = /<diff_file\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = diffRe.exec(rawText)) !== null) ops.push({ type: 'DIFF', icon: '📊', path: m[1], content: '', status: 'Diff показан' });
            // create_dir
            const mkdirRe = /<create_dir\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = mkdirRe.exec(rawText)) !== null) ops.push({ type: 'MKDIR', icon: '📁', path: m[1], content: '', status: 'Папка создана' });
            // install_package
            const installRe = /<install_package\s+name=["']([^"']+)["']\s*\/?>/gi;
            while ((m = installRe.exec(rawText)) !== null) ops.push({ type: 'INSTALL', icon: '📦', path: m[1], content: '', status: 'Установлено' });
            // run_command
            const cmdRe = /<run_command\s+cmd=["']([^"']+)["']\s*\/?>/gi;
            while ((m = cmdRe.exec(rawText)) !== null) ops.push({ type: 'CMD', icon: '⚡', path: m[1], content: '', status: 'Выполнено' });
            // download_file
            const downloadRe = /<download_file\s+url=["']([^"']+)["']\s+path=["']([^"']+)["']\s*\/?>/gi;
            while ((m = downloadRe.exec(rawText)) !== null) ops.push({ type: 'DOWNLOAD', icon: '⬇️', path: m[2], content: `URL: ${m[1]}`, status: 'Скачано' });
            // append_file
            const appendRe = /<append_file\s+path=["']([^"']+)["']>([\s\S]*?)<\/append_file>/gi;
            while ((m = appendRe.exec(rawText)) !== null) ops.push({ type: 'APPEND', icon: '➕', path: m[1], content: m[2].trim(), status: 'Добавлено' });
            // insert_at_line
            const insertRe = /<insert_at_line\s+path=["']([^"']+)["']\s+line=["'](\d+)["']>([\s\S]*?)<\/insert_at_line>/gi;
            while ((m = insertRe.exec(rawText)) !== null) ops.push({ type: 'INSERT', icon: '📍', path: `${m[1]}:${m[2]}`, content: m[3].trim(), status: 'Вставлено' });
            return ops;
        }

        function parseSearchSources(text) {
            const sources = [];
            const seenUrls = new Set();
            
            // Parse markdown links [title](url)
            const mdLinkRe = /\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g;
            let m;
            while ((m = mdLinkRe.exec(text)) !== null) {
                if (!seenUrls.has(m[2])) { 
                    seenUrls.add(m[2]); 
                    sources.push({ title: m[1], url: m[2] }); 
                }
            }
            
            // Parse citation style [1], [2] etc with nearby URLs
            const citationRe = /\[(\d+)\]/g;
            const urlsInText = text.match(/https?:\/\/[^\s\)\]<>"]+/g) || [];
            
            // Parse standalone URLs
            const urlRe = /(?<!\]\()https?:\/\/[^\s\)\]<>"]+/g;
            while ((m = urlRe.exec(text)) !== null) {
                const url = m[0].replace(/[.,;:!?]+$/, ''); // Clean trailing punctuation
                if (!seenUrls.has(url)) {
                    seenUrls.add(url);
                    try { 
                        const hostname = new URL(url).hostname.replace('www.', '');
                        sources.push({ title: hostname, url: url }); 
                    } catch {}
                }
            }
            
            // Parse reference style links like: 1. https://...
            const refRe = /^\s*(\d+)\.\s*(https?:\/\/[^\s]+)/gm;
            while ((m = refRe.exec(text)) !== null) {
                if (!seenUrls.has(m[2])) {
                    seenUrls.add(m[2]);
                    try { 
                        sources.push({ title: `Источник ${m[1]}`, url: m[2] }); 
                    } catch {}
                }
            }
            
            return sources.slice(0, 12);
        }

        function getDomainFromUrl(url) { try { return new URL(url).hostname.replace('www.', ''); } catch { return url; } }
        function getFaviconUrl(url) { try { return `https://www.google.com/s2/favicons?domain=${new URL(url).hostname}&sz=32`; } catch { return ''; } }

        // Parse pending (incomplete) file operations for streaming animation
        function parsePendingFileOps(text) {
            const pending = [];
            
            // Helper to check incomplete tags
            const checkIncomplete = (openRe, closeRe, type, icon, action) => {
                const opens = [...text.matchAll(openRe)];
                const closes = [...text.matchAll(closeRe)];
                if (opens.length > closes.length) {
                    const lastOpen = opens[opens.length - 1];
                    // Calculate approximate progress based on content length
                    const startIdx = lastOpen.index + lastOpen[0].length;
                    const contentAfter = text.substring(startIdx);
                    const lines = contentAfter.split('\n').length;
                    pending.push({ 
                        type, 
                        icon, 
                        path: lastOpen[1], 
                        status: action,
                        lines: lines
                    });
                }
            };
            
            checkIncomplete(/<create_file\s+path=["']([^"']+)["']>/gi, /<\/create_file>/gi, 'CREATE', '📄', 'Создание');
            checkIncomplete(/<edit_file\s+path=["']([^"']+)["']>/gi, /<\/edit_file>/gi, 'EDIT', '✏️', 'Редактирование');
            checkIncomplete(/<deploy_file\s+path=["']([^"']+)["']>/gi, /<\/deploy_file>/gi, 'DEPLOY', '🚀', 'Деплой');
            checkIncomplete(/<run_file\s+path=["']([^"']+)["']>/gi, /<\/run_file>/gi, 'RUN', '▶️', 'Выполнение');
            
            return pending;
        }

        function renderPendingFileOps(ops, stopped = false, failed = false) {
            return ops.map(op => {
                let statusText = op.status + '...';
                let statusClass = 'file-op-pending';
                let statusIcon = '⏳';
                if (stopped) { 
                    statusText = op.status + ' остановлено ⏹️'; 
                    statusClass = 'file-op-stopped'; 
                    statusIcon = '⏹️';
                }
                if (failed) { 
                    statusText = op.status + ' ошибка ❌'; 
                    statusClass = 'file-op-failed'; 
                    statusIcon = '❌';
                }
                const linesInfo = op.lines ? ` • ${op.lines} строк` : '';
                return `
                <div class="file-op-block ${statusClass}">
                    <div class="file-op-header">
                        <span class="file-op-icon">${op.icon}</span>
                        <span class="file-op-path">${escapeHtml(op.path)}</span>
                        <span class="file-op-type">${op.type}</span>
                    </div>
                    <div class="file-op-status">
                        <span class="file-op-indicator">${statusIcon} ${statusText}${linesInfo}</span>
                        ${!stopped && !failed ? '<div class="file-op-progress"><div class="file-op-progress-bar"></div></div>' : ''}
                    </div>
                </div>
            `}).join('');
        }

        function renderSearchSources(sources, searchOn) {
            if (!searchOn) return '';
            if (!sources || sources.length === 0) return `<div class="search-block"><div class="search-header"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>🔍 Поиск в интернете</div></div>`;
            const sourcesHtml = sources.map((src, idx) => {
                const domain = getDomainFromUrl(src.url), favicon = getFaviconUrl(src.url), title = src.title || domain;
                return `<a href="${escapeHtml(src.url)}" target="_blank" rel="noopener" class="search-source"><span class="search-source-number">${idx + 1}</span><div class="search-source-favicon"><img src="${favicon}" alt="" onerror="this.style.display='none';this.parentNode.textContent='🌐'"></div><div class="search-source-info"><div class="search-source-title">${escapeHtml(title.substring(0, 50))}</div><div class="search-source-url">${escapeHtml(domain)}</div></div></a>`;
            }).join('');
            const pl = sources.length === 1 ? '' : (sources.length < 5 ? 'а' : 'ов');
            return `<div class="search-block"><div class="search-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>🔍 Поиск в интернете • ${sources.length} источник${pl}</div><div class="search-sources"><div class="search-sources-title">Источники</div><div class="search-sources-grid">${sourcesHtml}</div></div></div>`;
        }
        
        function parseThinkingFromText(text) {
            const thinkRe = /<thinking>([\s\S]*?)<\/thinking>/gi;
            let thinking = '';
            let m;
            while ((m = thinkRe.exec(text)) !== null) thinking += m[1].trim() + '\n';
            return thinking.trim();
        }
        
        function removeThinkingTags(text) {
            return text.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '').trim();
        }
        
        function isThinkingComplete(text) {
            const openCount = (text.match(/<thinking>/gi) || []).length;
            const closeCount = (text.match(/<\/thinking>/gi) || []).length;
            return openCount > 0 && openCount === closeCount;
        }

        function removeFileOpTags(text) {
            return text
                .replace(/<create_file\s+path=["'][^"']+["']>[\s\S]*?<\/create_file>/gi, '')
                .replace(/<edit_file\s+path=["'][^"']+["']>[\s\S]*?<\/edit_file>/gi, '')
                .replace(/<read_file\s+[^>]+\/?>/gi, '')
                .replace(/<delete_file\s+[^>]+\/?>/gi, '')
                .replace(/<rename_file\s+[^>]+\/?>/gi, '')
                .replace(/<copy_file\s+[^>]+\/?>/gi, '')
                .replace(/<move_file\s+[^>]+\/?>/gi, '')
                .replace(/<list_files\s+[^>]+\/?>/gi, '')
                .replace(/<run_file\s+[^>]+\/?>/gi, '')
                .replace(/<deploy_file\s+[^>]+\/?>/gi, '')
                .replace(/<search_in_file\s+[^>]+\/?>/gi, '')
                .replace(/<diff_file\s+[^>]+\/?>/gi, '')
                .replace(/<create_dir\s+[^>]+\/?>/gi, '')
                .replace(/<install_package\s+[^>]+\/?>/gi, '')
                .replace(/<run_command\s+[^>]+\/?>/gi, '')
                .replace(/<download_file\s+[^>]+\/?>/gi, '')
                .replace(/<append_file\s+path=["'][^"']+["']>[\s\S]*?<\/append_file>/gi, '')
                .replace(/<insert_at_line\s+[^>]+>[\s\S]*?<\/insert_at_line>/gi, '')
                .trim();
        }

        function formatContent(text) {
            if (!text) return '';
            let h = escapeHtml(text);
            // Десятичные дроби и числа - подсветка
            h = h.replace(/(\d+[.,]\d+)/g, '<span style="color:var(--accent);font-weight:500">$1</span>');
            // Проценты
            h = h.replace(/(\d+)%/g, '<span style="color:var(--accent);font-weight:500">$1%</span>');
            // Простые дроби типа 1/2, 3/4 → красивые дроби
            h = h.replace(/\b1\/2\b/g, '½');
            h = h.replace(/\b1\/3\b/g, '⅓');
            h = h.replace(/\b2\/3\b/g, '⅔');
            h = h.replace(/\b1\/4\b/g, '¼');
            h = h.replace(/\b3\/4\b/g, '¾');
            h = h.replace(/\b1\/5\b/g, '⅕');
            h = h.replace(/\b2\/5\b/g, '⅖');
            h = h.replace(/\b3\/5\b/g, '⅗');
            h = h.replace(/\b4\/5\b/g, '⅘');
            h = h.replace(/\b1\/6\b/g, '⅙');
            h = h.replace(/\b5\/6\b/g, '⅚');
            h = h.replace(/\b1\/8\b/g, '⅛');
            h = h.replace(/\b3\/8\b/g, '⅜');
            h = h.replace(/\b5\/8\b/g, '⅝');
            h = h.replace(/\b7\/8\b/g, '⅞');
            // Другие дроби → sup/sub формат
            h = h.replace(/(\d+)\/(\d+)/g, '<sup>$1</sup>⁄<sub>$2</sub>');
            h = h.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
                const isJs = ['javascript','js'].includes(lang.toLowerCase());
                return `<div class="code-header"><span class="code-lang">${lang||'code'}</span><div class="code-actions"><button class="code-btn" onclick="copyCodeBlock(this)">📋 Копировать</button>${isJs?'<button class="code-btn" onclick="runCode(this)">▶️ Запустить</button>':''}</div></div><pre class="with-header"><code>${code.trim()}</code></pre>`;
            });
            h = h.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
            h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            h = h.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            h = h.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            h = h.replace(/^---$/gm, '<hr>');
            h = h.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
            h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            h = h.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
            h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            h = h.replace(/^&gt; (.+)$/gm, '<blockquote><p>$1</p></blockquote>');
            h = h.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            h = h.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
            h = h.replace(/(<li>[\s\S]*?<\/li>)+/g, m => `<ul>${m}</ul>`);
            h = h.split('\n\n').map(p => p.trim() && !p.startsWith('<') ? `<p>${p}</p>` : p).join('');
            h = h.replace(/\n/g, '<br>');
            return h;
        }

        function renderFileOps(ops) {
            return ops.map((op, idx) => {
                const ext = op.path.split('.').pop().toLowerCase();
                const langLabel = ext.toUpperCase() || 'FILE';
                const codeId = `file-op-code-${Date.now()}-${idx}`;
                
                // Content is hidden by default - user can click to expand
                return `
                <div class="file-op-block">
                    <div class="file-op-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('visible')">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                        <span class="file-op-icon" style="font-family:'Google Sans Mono',monospace;font-weight:600;">${op.icon}</span>
                        <span class="file-op-path">${escapeHtml(op.path)}</span>
                        <span class="file-op-type">${op.type}</span>
                        <span style="margin-left:8px;color:var(--success);font-size:12px;">✓</span>
                    </div>
                    <div class="file-op-content">
                        ${op.content ? `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:#2d2d2d;border-bottom:1px solid #404040;">
                                <span style="color:#888;font-size:12px;font-weight:500;">${langLabel}</span>
                                <button class="code-btn" onclick="copyFileOpCode('${codeId}')">[copy]</button>
                            </div>
                            <div class="file-op-code" id="${codeId}">${escapeHtml(op.content)}</div>
                        ` : ''}
                        <div class="file-op-status">✅ ${op.status}</div>
                    </div>
                </div>
            `}).join('');
        }
        
        async function copyFileOpCode(id) {
            const el = document.getElementById(id);
            if (el) {
                await copyToClipboard(el.textContent);
                showToast('✅ Код скопирован');
            }
        }

        function addMessage(role, content, extras = {}) {
            const msgsEl = document.getElementById('messages');
            const msgEl = document.createElement('div');
            msgEl.className = `message ${role}`;
            const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const author = role === 'user' ? (currentUser ? currentUser.first_name : 'Вы') : currentModel.name;
            
            // User avatar - use Telegram photo if available
            let userAvatar;
            if (role === 'user') {
                if (currentUser && currentUser.photo_url) {
                    userAvatar = `<img src="${currentUser.photo_url}" alt="${currentUser.first_name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                } else if (currentUser && currentUser.first_name) {
                    userAvatar = currentUser.first_name.charAt(0).toUpperCase();
                } else {
                    userAvatar = 'Я';
                }
            }
            const avatar = role === 'user' ? userAvatar : getModelAvatar(currentModel.id);

            let extrasHtml = '';
            if (extras.images?.length) extrasHtml += '<div class="message-attachments">' + extras.images.map(img => `<img src="${img.data}" class="message-attachment-img" onclick="openImageModal('${img.data}')">`).join('') + '</div>';
            if (extras.files?.length) extrasHtml += '<div class="message-attachments">' + extras.files.map(f => `<div class="message-attachment-file">📄 ${f.name}</div>`).join('') + '</div>';
            
            if (extras.thinking) {
                // Always start collapsed - user can expand if interested
                extrasHtml += `<div class="thinking-block"><div class="thinking-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('visible')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>🧠 Размышления модели</div><div class="thinking-content">${formatContent(extras.thinking)}</div></div>`;
            }
            if (extras.searchOn) extrasHtml += renderSearchSources(extras.searchSources || [], extras.searchOn);
            if (extras.fileOps?.length) extrasHtml += renderFileOps(extras.fileOps);

            let genTimeHtml = extras.genTime ? `<span class="message-gen-time">${extras.genTime}</span>` : '';

            msgEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-body">
                    <div class="message-header"><span class="message-author">${author}</span><span class="message-time">${time}</span>${genTimeHtml}</div>
                    <div class="message-content">${extrasHtml}${formatContent(content)}</div>
                    <div class="message-actions">
                        <button class="action-btn" onclick="copyMessageText(this)">📋 Копировать</button>
                        ${role === 'assistant' ? '<button class="action-btn" onclick="regenerateResponse()">🔄 Ещё раз</button>' : ''}
                        <button class="action-btn" onclick="deleteMessage(this)" style="margin-left:auto">🗑️</button>
                    </div>
                </div>
            `;
            
            msgsEl.appendChild(msgEl);
            if (document.getElementById('autoScrollToggle').checked) msgsEl.scrollTop = msgsEl.scrollHeight;
            return msgEl;
        }

        function runCode(btn) {
            const code = btn.closest('.code-header').nextElementSibling.querySelector('code').textContent;
            try {
                const origLog = console.log;
                let output = [];
                console.log = (...args) => output.push(args.join(' '));
                const result = eval(code);
                console.log = origLog;
                showToast('✅ ' + (output.join('\n') || String(result) || 'Выполнено'));
            } catch (e) { showToast('❌ ' + e.message); }
        }

        async function copyMessageText(btn) { await copyToClipboard(btn.closest('.message-body').querySelector('.message-content').innerText); showToast('✅ Скопировано'); }
        async function copyCodeBlock(btn) { await copyToClipboard(btn.closest('.code-header').nextElementSibling.textContent); showToast('✅ Код скопирован'); }

        async function copyToClipboard(text) {
            try { await navigator.clipboard.writeText(text); }
            catch { const t = document.createElement('textarea'); t.value = text; t.style.cssText = 'position:fixed;opacity:0'; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); }
        }

        function deleteMessage(btn) { const el = btn.closest('.message'); const i = Array.from(document.querySelectorAll('.message')).indexOf(el); if (i !== -1) conversationHistory.splice(i, 1); el.remove(); }
        function regenerateResponse() { if (conversationHistory.length < 2) return; conversationHistory.pop(); document.getElementById('messages').lastElementChild?.remove(); generateResponse(); }
        function openImageModal(src) { document.getElementById('modalImage').src = src; document.getElementById('imageModal').classList.add('show'); }
        function closeImageModal() { document.getElementById('imageModal').classList.remove('show'); }
        function showToast(msg, dur = 3000) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), dur); }

        // Particles removed

        function updateWelcomeGreeting() {
            const titleEl = document.querySelector('.welcome-title');
            if (!titleEl) return;
            
            if (currentUser && currentUser.first_name) {
                const hour = new Date().getHours();
                let greeting;
                if (hour >= 6 && hour < 12) {
                    greeting = `Доброе утро, ${currentUser.first_name}! ☀️`;
                } else if (hour >= 12 && hour < 18) {
                    greeting = `Добрый день, ${currentUser.first_name}! 🌤️`;
                } else if (hour >= 18 && hour < 22) {
                    greeting = `Добрый вечер, ${currentUser.first_name}! 🌅`;
                } else {
                    greeting = `Доброй ночи, ${currentUser.first_name}! 🌙`;
                }
                titleEl.textContent = greeting;
            } else {
                titleEl.textContent = 'Привет!';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message && !attachedImages.length && !attachedFiles.length || isGenerating) return;
            
            // Message sent

            const welcomeScreen = document.getElementById('welcomeScreen');
            const messagesWrapper = document.getElementById('messagesWrapper');
            
            if (!welcomeScreen.classList.contains('hidden')) {
                welcomeScreen.classList.add('hiding');
                setTimeout(() => {
                    welcomeScreen.classList.add('hidden');
                    messagesWrapper.classList.remove('hidden');
                    messagesWrapper.classList.add('showing');
                    setTimeout(() => messagesWrapper.classList.remove('showing'), 300);
                }, 200);
            } else {
                messagesWrapper.classList.remove('hidden');
            }
            document.getElementById('newChatBtn').style.display = 'flex';

            const curImgs = [...attachedImages], curFiles = [...attachedFiles];
            addMessage('user', message, { images: curImgs, files: curFiles });

            let msgContent = message;
            if ((curFiles.length || curImgs.length) && !msgContent.toLowerCase().includes('english')) msgContent = `[Отвечай на русском языке]\n\n${msgContent}`;
            if (curFiles.length) { msgContent += '\n\n--- Прикреплённые файлы ---'; curFiles.forEach(f => msgContent += `\n\n📄 ${f.name}:\n\`\`\`${f.type.toLowerCase()}\n${f.content}\n\`\`\``); }
            if (curImgs.length) msgContent += '\n\n[Прикреплены изображения для анализа]';

            let finalContent;
            if (curImgs.length && (currentModel.caps.includes('vision') || currentModel.type !== 'text')) {
                finalContent = [{ type: 'text', text: msgContent }, ...curImgs.map(img => ({ type: 'image_url', image_url: { url: img.data } }))];
            } else finalContent = msgContent;

            conversationHistory.push({ role: 'user', content: finalContent });
            input.value = ''; input.style.height = 'auto';
            attachedImages = []; attachedFiles = [];
            document.getElementById('attachedFiles').innerHTML = '';
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('charCount').textContent = '0 / 32,000';

            // Scroll to bottom when sending message
            setTimeout(() => {
                document.getElementById('messages').scrollTo({ top: document.getElementById('messages').scrollHeight, behavior: 'smooth' });
            }, 100);
            
            // Update lastActive for online status
            if (currentUser && useCloudSync) {
                db.ref('users/' + currentUser.id + '/lastActive').set(Date.now());
            }
            
            if (currentModel.type === 'image') await generateImage(message, curImgs);
            else await generateResponse();
        }

        async function generateImage(prompt, images = []) {
            isGenerating = true; updateSendButton(); generationStartTime = Date.now();
            const msgsEl = document.getElementById('messages');
            const loadEl = document.createElement('div');
            loadEl.className = 'message assistant';
            loadEl.innerHTML = `<div class="message-avatar">${getModelAvatar(currentModel.id)}</div><div class="message-body"><div class="message-header"><span class="message-author">${currentModel.name}</span></div><div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><p>🎨 Генерирую изображение...</p></div></div>`;
            msgsEl.appendChild(loadEl);

            try {
                const url = `${API_BASE}/image/${encodeURIComponent(prompt)}?model=${currentModel.id}&nologo=true&seed=${Date.now()}`;
                const genTime = ((Date.now() - generationStartTime) / 1000).toFixed(1) + 's';
                const img = new Image();
                img.onload = () => {
                    loadEl.remove();
                    addMessage('assistant', `🎨 **Изображение готово!**\n\nМодель: *${currentModel.name}*\nПромпт: "${prompt}"`, { genTime });
                    const lastC = document.querySelector('.message.assistant:last-child .message-content');
                    if (lastC) lastC.innerHTML += `<img src="${url}" class="generated-image" onclick="openImageModal('${url}')">`;
                    conversationHistory.push({ role: 'assistant', content: `[Изображение: ${prompt}]` });
                    isGenerating = false; updateSendButton(); saveChat();
                };
                img.onerror = () => { loadEl.remove(); addMessage('assistant', '❌ Ошибка генерации изображения'); isGenerating = false; updateSendButton(); };
                img.src = url;
            } catch (e) { loadEl.remove(); addMessage('assistant', `❌ ${e.message}`); isGenerating = false; updateSendButton(); }
        }

        async function generateResponse() {
            // Check if admin-only mode is enabled
            if (currentUser && useCloudSync) {
                const adminOnlySnap = await db.ref('settings/adminOnly').once('value');
                if (adminOnlySnap.val() === true) {
                    addMessage('assistant', '⏳ Ожидайте ответа оператора...\n\nРежим "только админ" включён. Администратор скоро ответит вам.');
                    return;
                }
            }
            
            isGenerating = true; updateSendButton(); generationStartTime = Date.now();
            abortController = new AbortController();

            const msgsEl = document.getElementById('messages');
            const typingEl = document.createElement('div');
            typingEl.className = 'message assistant';
            typingEl.innerHTML = `<div class="message-avatar">${getModelAvatar(currentModel.id)}</div><div class="message-body"><div class="message-header"><span class="message-author">${currentModel.name}</span></div><div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>`;
            msgsEl.appendChild(typingEl);

            try {
                const streaming = document.getElementById('streamingToggle').checked;
                let sysPrompt = document.getElementById('systemPrompt').value.trim();
                const codeOn = document.getElementById('codeExecToggle').checked && !document.getElementById('codeExecToggle').disabled;
                const reasonOn = document.getElementById('reasoningToggle').checked && !document.getElementById('reasoningToggle').disabled;
                const searchOn = document.getElementById('searchToggle').checked && !document.getElementById('searchToggle').disabled;

                if (codeOn) {
                    sysPrompt = CODE_MODE_PROMPT + (sysPrompt ? '\n\n' + sysPrompt : '');
                    // Добавляем напоминание в последнее сообщение пользователя
                    const lastUserMsgIdx = messages.length - 1;
                    if (messages[lastUserMsgIdx] && messages[lastUserMsgIdx].role === 'user') {
                        const content = messages[lastUserMsgIdx].content;
                        if (typeof content === 'string') {
                            messages[lastUserMsgIdx].content = content + '\n\n[НАПОМИНАНИЕ: Используй <create_file path="..."> для создания файлов. Пиши ВЕСЬ код полностью!]';
                        }
                    }
                }
                
                if (reasonOn) {
                    const reasoningInstruction = `

ВАЖНО: Ты должен показать свой процесс размышления. Используй следующий формат:

<thinking>
Здесь напиши свои пошаговые рассуждения, анализ задачи, возможные подходы к решению.
Это твой внутренний монолог, где ты думаешь над задачей.
</thinking>

После блока thinking дай свой финальный ответ пользователю.`;
                    sysPrompt = (sysPrompt || '') + reasoningInstruction;
                }

                const messages = [];
                if (sysPrompt) messages.push({ role: 'system', content: sysPrompt });
                messages.push(...conversationHistory);

                const body = {
                    model: currentModel.id,
                    messages,
                    stream: streaming,
                    temperature: parseFloat(document.getElementById('temperatureSlider').value),
                    max_tokens: parseInt(document.getElementById('tokensSlider').value)
                };

                const res = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: abortController.signal
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                typingEl.remove();

                if (streaming) {
                    const respEl = addMessage('assistant', '');
                    const contentEl = respEl.querySelector('.message-content');
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = '', thinkText = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        for (const line of chunk.split('\n')) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices?.[0]?.delta;
                                    const message = json.choices?.[0]?.message;
                                    if (delta || message) {
                                        const reasoningDelta = delta?.reasoning_content || delta?.thinking || message?.reasoning_content || message?.thinking || '';
                                        if (reasoningDelta) thinkText += reasoningDelta;
                                        
                                        const contentDelta = delta?.content || message?.content || '';
                                        if (contentDelta) fullText += contentDelta;

                                        const inlineThinking = parseThinkingFromText(fullText);
                                        const combinedThinking = (thinkText + ' ' + inlineThinking).trim();
                                        
                                        let cleanFullText = removeThinkingTags(fullText);

                                        let displayHtml = '';
                                        
                                        if (combinedThinking) {
                                            // Thinking block - collapsed by default, content visible only during streaming
                                            displayHtml += `<div class="thinking-block"><div class="thinking-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('visible')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>🧠 Думаю...</div><div class="thinking-content">${formatContent(combinedThinking)}</div></div>`;
                                        }
                                        
                                        if (searchOn) {
                                            const sources = parseSearchSources(cleanFullText);
                                            displayHtml += renderSearchSources(sources, searchOn);
                                        }

                                        const fileOps = parseFileOperations(cleanFullText);
                                        if (fileOps.length) {
                                            displayHtml += renderFileOps(fileOps);
                                        }

                                        // Show pending operations with animation (hide raw code)
                                        const pendingOps = parsePendingFileOps(cleanFullText);
                                        lastPendingOps = pendingOps; // Save for stop handling
                                        if (pendingOps.length) {
                                            displayHtml += renderPendingFileOps(pendingOps);
                                        }

                                        // Remove incomplete file operation content from display
                                        let cleanText = removeFileOpTags(cleanFullText);
                                        // Also hide any text that looks like it's inside an incomplete tag
                                        cleanText = cleanText.replace(/<create_file[^>]*>[\s\S]*/gi, '');
                                        cleanText = cleanText.replace(/<edit_file[^>]*>[\s\S]*/gi, '');
                                        
                                        if (cleanText.trim()) {
                                            displayHtml += formatContent(cleanText);
                                        } else if (!fileOps.length && !pendingOps.length && !combinedThinking) {
                                            displayHtml += '<span class="gradient-loading">✨ Генерирую ответ...</span>';
                                        }
                                        
                                        contentEl.innerHTML = displayHtml;

                                        if (document.getElementById('autoScrollToggle').checked) msgsEl.scrollTop = msgsEl.scrollHeight;
                                    }
                                } catch {}
                            }
                        }
                    }

                    const thinkHdr = contentEl.querySelector('.thinking-header');
                    if (thinkHdr && isThinkingComplete(fullText)) { 
                        thinkHdr.classList.add('collapsed'); 
                        thinkHdr.nextElementSibling.classList.add('hidden'); 
                    }

                    const genTime = ((Date.now() - generationStartTime) / 1000).toFixed(1) + 's';
                    respEl.querySelector('.message-header').innerHTML += `<span class="message-gen-time">${genTime}</span>`;
                    conversationHistory.push({ role: 'assistant', content: fullText });
                    
                    // Process file operations and add to explorer
                    processFileOperations(fullText);
                } else {
                    const json = await res.json();
                    const msg = json.choices?.[0]?.message;
                    const content = msg?.content || 'Нет ответа';
                    
                    let thinkContent = msg?.reasoning_content || msg?.thinking || msg?.reasoning || json.thinking || '';
                    
                    const inlineThinking = parseThinkingFromText(content);
                    if (inlineThinking) thinkContent = (thinkContent + '\n' + inlineThinking).trim();
                    
                    let cleanContent = removeThinkingTags(content);
                    
                    const genTime = ((Date.now() - generationStartTime) / 1000).toFixed(1) + 's';
                    const extras = { genTime };
                    if (thinkContent) { extras.thinking = thinkContent; extras.thinkingComplete = true; }
                    if (searchOn) {
                        const sources = parseSearchSources(cleanContent);
                        extras.searchSources = sources;
                        extras.searchOn = true;
                    }
                    
                    const fileOps = parseFileOperations(cleanContent);
                    if (fileOps.length) extras.fileOps = fileOps;
                    
                    cleanContent = removeFileOpTags(cleanContent);
                    addMessage('assistant', cleanContent, extras);
                    conversationHistory.push({ role: 'assistant', content });
                    
                    // Process file operations and add to explorer
                    processFileOperations(content);
                }

                saveChat();
            } catch (e) {
                typingEl.remove();
                if (e.name === 'AbortError') {
                    // Already handled in stopGeneration
                } else {
                    // Show failed state for pending operations
                    const lastMsgContent = document.querySelector('.message.assistant:last-child .message-content');
                    if (lastMsgContent && lastPendingOps.length) {
                        const pendingBlocks = lastMsgContent.querySelectorAll('.file-op-pending');
                        pendingBlocks.forEach(block => {
                            block.classList.remove('file-op-pending');
                            block.classList.add('file-op-failed');
                            const status = block.querySelector('.file-op-status');
                            if (status) {
                                const indicator = status.querySelector('.file-op-indicator');
                                if (indicator) indicator.textContent = '❌ Ошибка генерации';
                                const progress = status.querySelector('.file-op-progress');
                                if (progress) progress.remove();
                            }
                        });
                    }
                    addMessage('assistant', `❌ Ошибка: ${e.message}`);
                }
            }

            isGenerating = false; abortController = null; lastPendingOps = []; updateSendButton();
        }

        async function saveChat() {
            if (conversationHistory.length < 2) return;
            const first = conversationHistory[0]?.content;
            let title = typeof first === 'string' ? first.substring(0, 40) : first?.find?.(p => p?.type === 'text')?.text?.substring(0, 40) || 'Чат';
            
            const chatData = {
                title: title + '...',
                messages: conversationHistory.map(m => ({
                    role: m.role,
                    content: typeof m.content === 'string' ? m.content : m.content?.find?.(p => p?.type === 'text')?.text || ''
                })),
                model: currentModel.id,
                modelName: currentModel.name,
                updatedAt: Date.now()
            };
            
            // Always save to localStorage
            let localChats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            if (!chatId) {
                chatId = 'local_' + Date.now();
            }
            
            const existingIdx = localChats.findIndex(c => c.id === chatId);
            if (existingIdx !== -1) {
                localChats[existingIdx] = { id: chatId, ...chatData };
            } else {
                localChats.unshift({ id: chatId, ...chatData });
            }
            
            // Keep only last 50 chats
            if (localChats.length > 50) localChats = localChats.slice(0, 50);
            localStorage.setItem('chatHistory', JSON.stringify(localChats));
            
            // If logged in, also save to Firebase
                if (currentUser && useCloudSync) {
                    const cloudChatId = chatId.startsWith('local_') ? chatId : chatId;
                    await db.ref('users/' + currentUser.id + '/chats/' + cloudChatId).set(chatData);
                    // Update lastActive for online status
                    db.ref('users/' + currentUser.id + '/lastActive').set(Date.now());
                }
            
            loadChatHistory();
        }

        function loadChatHistory() {
            // Load from localStorage by default
            let localChats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            if (currentUser && useCloudSync) {
                // If logged in, merge with cloud chats
                db.ref('users/' + currentUser.id + '/chats').orderByChild('updatedAt').limitToLast(30).once('value', snap => {
                    const cloudChats = [];
                    snap.forEach(child => {
                        cloudChats.push({ id: child.key, ...child.val() });
                    });
                    
                    // Merge and dedupe
                    const allChats = [...cloudChats];
                    localChats.forEach(lc => {
                        if (!allChats.find(cc => cc.id === lc.id)) {
                            allChats.push(lc);
                        }
                    });
                    
                    // Sort by updatedAt
                    allChats.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                    renderChatHistory(allChats.slice(0, 30));
                });
            } else {
                renderChatHistory(localChats);
            }
        }

        function renderChatHistory(chats) {
            const c = document.getElementById('historyList');
            if (!chats.length) { c.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px">История пуста</p>'; return; }
            c.innerHTML = chats.map(ch => `<div class="setting-item" style="cursor:pointer" onclick="loadChat('${ch.id}')"><div class="setting-info"><div class="setting-name">${ch.title}</div><div class="setting-desc">${ch.modelName || ch.model || ''}</div></div><button class="action-btn" onclick="event.stopPropagation();deleteChat('${ch.id}')" style="padding:6px">🗑️</button></div>`).join('');
        }

        function loadChat(id) {
            // First try localStorage
            const localChats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            let data = localChats.find(c => c.id === id);
            
            const loadChatData = (chatData) => {
                if (!chatData) return;
                chatId = id;
                conversationHistory = chatData.messages || [];
                
                document.getElementById('messages').innerHTML = '';
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('messagesWrapper').classList.remove('hidden');
                document.getElementById('newChatBtn').style.display = 'flex';
                
                conversationHistory.forEach(msg => {
                    addMessage(msg.role, msg.content, {});
                });
                
                // Load files for this chat
                loadFilesForChat();
                
                toggleHistory();
            };
            
            if (data) {
                loadChatData(data);
            } else if (currentUser && useCloudSync) {
                // Try cloud
                db.ref('users/' + currentUser.id + '/chats/' + id).once('value', snap => {
                    loadChatData(snap.val());
                });
            }
        }

        function deleteChat(id) {
            if (!confirm('Удалить этот чат?')) return;
            
            // Delete from localStorage
            let localChats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            localChats = localChats.filter(c => c.id !== id);
            localStorage.setItem('chatHistory', JSON.stringify(localChats));
            
            // Delete from cloud if logged in
            if (currentUser && useCloudSync) {
                db.ref('users/' + currentUser.id + '/chats/' + id).remove();
            }
            
            if (chatId === id) newChat();
            loadChatHistory();
        }

        function clearAllChats() {
            if (!confirm('Удалить всю историю?')) return;
            
            // Clear localStorage
            localStorage.removeItem('chatHistory');
            
            // Clear cloud if logged in
            if (currentUser && useCloudSync) {
                db.ref('users/' + currentUser.id + '/chats').remove();
            }
            
            newChat();
            loadChatHistory();
        }

        function exportChat() {
            if (!conversationHistory.length) return showToast('Нет сообщений для экспорта');
            const blob = new Blob([JSON.stringify({ model: currentModel, messages: conversationHistory, exported: new Date().toISOString() }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `chat-${Date.now()}.json`; a.click();
            showToast('✅ Чат экспортирован');
        }

        // ============ FILE EXPLORER FUNCTIONS ============
        
        function toggleFileExplorer() {
            const explorer = document.getElementById('fileExplorer');
            const overlay = document.getElementById('overlay');
            const isOpen = explorer.classList.toggle('open');
            overlay.classList.toggle('show', isOpen);
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'html': '🌐', 'htm': '🌐',
                'css': '🎨',
                'js': '📜', 'jsx': '⚛️', 'ts': '📘', 'tsx': '⚛️',
                'json': '📋',
                'py': '🐍',
                'md': '📝',
                'txt': '📄',
                'png': '🖼️', 'jpg': '🖼️', 'jpeg': '🖼️', 'gif': '🖼️', 'svg': '🎭',
                'pdf': '📕',
                'zip': '📦', 'rar': '📦',
                'mp3': '🎵', 'wav': '🎵',
                'mp4': '🎬', 'webm': '🎬',
                'sh': '⚡', 'bat': '⚡',
                'sql': '🗃️',
                'xml': '📰',
                'yaml': '⚙️', 'yml': '⚙️'
            };
            return icons[ext] || '📄';
        }

        function addFileToExplorer(path, content) {
            virtualFS[path] = { content, size: content.length, createdAt: Date.now() };
            renderFileExplorer();
            saveFilesForChat();
        }

        function removeFileFromExplorer(path) {
            delete virtualFS[path];
            renderFileExplorer();
            saveFilesForChat();
        }

        function renderFileExplorer() {
            const container = document.getElementById('fileExplorerContent');
            const files = Object.keys(virtualFS);
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="file-empty">
                        <p>📂 Файлы появятся здесь</p>
                        <p style="font-size:12px;margin-top:8px;">Попросите AI создать файл</p>
                    </div>
                `;
                return;
            }
            
            // Group by folders
            const tree = {};
            files.forEach(path => {
                const parts = path.split('/');
                if (parts.length === 1) {
                    tree[path] = virtualFS[path];
                } else {
                    const folder = parts[0];
                    if (!tree[folder]) tree[folder] = { _isFolder: true, children: {} };
                    tree[folder].children[parts.slice(1).join('/')] = virtualFS[path];
                }
            });
            
            let html = '';
            for (const [name, data] of Object.entries(tree)) {
                if (data._isFolder) {
                    html += `
                        <div class="file-tree-folder">
                            <div class="file-tree-item" onclick="toggleFolder(this)">
                                <span class="file-tree-icon">📁</span>
                                <span class="file-tree-name">${escapeHtml(name)}</span>
                            </div>
                            <div class="file-tree-children">
                                ${Object.entries(data.children).map(([childName, childData]) => `
                                    <div class="file-tree-item" onclick="previewFile('${name}/${childName}')">
                                        <span class="file-tree-icon">${getFileIcon(childName)}</span>
                                        <span class="file-tree-name">${escapeHtml(childName)}</span>
                                        <span class="file-tree-size">${formatFileSize(childData.size)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="file-tree-item" onclick="previewFile('${name}')">
                            <span class="file-tree-icon">${getFileIcon(name)}</span>
                            <span class="file-tree-name">${escapeHtml(name)}</span>
                            <span class="file-tree-size">${formatFileSize(data.size)}</span>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }

        function toggleFolder(el) {
            el.parentElement.classList.toggle('collapsed');
        }

        function previewFile(path) {
            const file = virtualFS[path];
            if (!file) return;
            
            currentPreviewFile = path;
            document.getElementById('filePreviewTitle').innerHTML = `${getFileIcon(path)} ${path}`;
            document.getElementById('filePreviewBody').textContent = file.content;
            document.getElementById('filePreviewModal').classList.add('show');
            
            // Show "Open" button for HTML files
            const ext = path.split('.').pop().toLowerCase();
            const openBtn = document.getElementById('openInTabBtn');
            openBtn.style.display = ['html', 'htm'].includes(ext) ? 'flex' : 'none';
        }

        function closeFilePreview(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('filePreviewModal').classList.remove('show');
            }
        }

        function copyFileContent() {
            if (!currentPreviewFile || !virtualFS[currentPreviewFile]) return;
            copyToClipboard(virtualFS[currentPreviewFile].content);
            showToast('✅ Содержимое скопировано');
        }

        function downloadCurrentFile() {
            if (!currentPreviewFile || !virtualFS[currentPreviewFile]) return;
            const file = virtualFS[currentPreviewFile];
            const blob = new Blob([file.content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentPreviewFile.split('/').pop();
            a.click();
            showToast('✅ Файл скачан');
        }

        function openInNewTab() {
            if (!currentPreviewFile || !virtualFS[currentPreviewFile]) return;
            const file = virtualFS[currentPreviewFile];
            const ext = currentPreviewFile.split('.').pop().toLowerCase();
            
            if (['html', 'htm'].includes(ext)) {
                const blob = new Blob([file.content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                showToast('🚀 Открыто в новой вкладке');
            } else {
                showToast('❌ Можно открыть только HTML файлы');
            }
        }

        function deleteCurrentFile() {
            if (!currentPreviewFile) return;
            if (!confirm('Удалить файл ' + currentPreviewFile + '?')) return;
            removeFileFromExplorer(currentPreviewFile);
            closeFilePreview();
            showToast('🗑️ Файл удалён');
        }

        function createNewFile() {
            const name = prompt('Имя файла:', 'new_file.txt');
            if (!name) return;
            addFileToExplorer(name, '');
            showToast('✅ Файл создан');
        }

        function createNewFolder() {
            const name = prompt('Имя папки:', 'new_folder');
            if (!name) return;
            addFileToExplorer(name + '/.keep', '');
            showToast('✅ Папка создана');
        }

        function saveFilesForChat() {
            if (chatId) {
                // Save to localStorage
                let allFiles = JSON.parse(localStorage.getItem('chatFiles') || '{}');
                allFiles[chatId] = virtualFS;
                localStorage.setItem('chatFiles', JSON.stringify(allFiles));
                
                // Save to cloud if logged in
                if (currentUser && useCloudSync) {
                    db.ref('users/' + currentUser.id + '/files/' + chatId).set(virtualFS);
                }
            }
        }

        function loadFilesForChat() {
            if (chatId) {
                // Load from localStorage first
                const allFiles = JSON.parse(localStorage.getItem('chatFiles') || '{}');
                virtualFS = allFiles[chatId] || {};
                renderFileExplorer();
                
                // Merge from cloud if logged in
                if (currentUser && useCloudSync) {
                    db.ref('users/' + currentUser.id + '/files/' + chatId).once('value', snap => {
                        const cloudFiles = snap.val() || {};
                        virtualFS = { ...virtualFS, ...cloudFiles };
                        renderFileExplorer();
                    });
                }
            }
        }

        // Voice input removed

        // Hook into file operations from AI response
        function processFileOperations(text) {
            const ops = parseFileOperations(text);
            ops.forEach(op => {
                if (op.type === 'CREATE' || op.type === 'APPEND') {
                    addFileToExplorer(op.path, op.content);
                } else if (op.type === 'DELETE') {
                    removeFileFromExplorer(op.path);
                } else if (op.type === 'EDIT' && virtualFS[op.path]) {
                    // Simple edit - just show the new content
                    addFileToExplorer(op.path, op.content);
                }
            });
        }
    </script>
</body>
</html>
